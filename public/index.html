<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>TONAggregator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
    :root {
      --bg: #f0f4f8; /* –ë–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
      --text: #333; /* –ß—É—Ç—å –º—è–≥—á–µ —á–µ—Ä–Ω—ã–π */
      --card-bg: #ffffff;
      --header-bg: #007bff; /* –Ø—Ä–∫–∏–π —Å–∏–Ω–∏–π –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞ */
      --header-text: #ffffff;
      --nav-bg: #ffffff;
      --nav-link: #007bff;
      --nav-link-active-bg: #e9ecef;
      --input-bg: #ffffff;
      --input-text: #333;
      --border-color: #dee2e6; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Bootstrap —Ü–≤–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --spinner-border: #007bff;
      --success-color: #28a745;
      --error-color: #dc3545;
      --star-color: #ffc107; /* –¶–≤–µ—Ç –¥–ª—è –∑–≤–µ–∑–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞ */
      --button-primary-bg: #007bff;
      --button-primary-text: #ffffff;
      --button-secondary-bg: #6c757d;
      --button-secondary-text: #ffffff;
    }
    body.dark {
      --bg: #121212; /* –ì–ª—É–±–æ–∫–∏–π —Ç–µ–º–Ω—ã–π */
      --text: #e0e0e0;
      --card-bg: #1e1e1e; /* –¢–µ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
      --header-bg: #1f1f1f; /* –¢–µ–º–Ω—ã–π —Ö–µ–¥–µ—Ä */
      --header-text: #e0e0e0;
      --nav-bg: #1a1a1a;
      --nav-link: #bb86fc; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
      --nav-link-active-bg: #332244;
      --input-bg: #2c2c2c;
      --input-text: #e0e0e0;
      --border-color: #444444;
      --spinner-border: #bb86fc;
      --star-color: #fdd835;
      --button-primary-bg: #bb86fc;
      --button-primary-text: #121212;
      --button-secondary-bg: #373737;
      --button-secondary-text: #e0e0e0;
    }
    body { 
      background: var(--bg); 
      color: var(--text); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* –ë–æ–ª–µ–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç */
      margin: 0; 
      padding-top: 70px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
      padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
      transition: background 0.3s, color 0.3s; 
      line-height: 1.6;
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    header { 
      padding: 0.8rem 1rem; 
      text-align: center; 
      background: var(--header-bg); 
      color: var(--header-text); 
      position: fixed; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–µ–¥–µ—Ä */
      top: 0;
      left: 0;
      right: 0;
      z-index: 1030; /* –í—ã—à–µ —á–µ–º bottom-nav */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 { font-size: 1.5rem; margin: 0; }
    #themeToggle, #langToggle { 
      position: absolute; 
      top: 50%;
      transform: translateY(-50%);
      background: transparent; 
      border: none; 
      font-size: 1.5rem; /* –ö—Ä—É–ø–Ω–µ–µ –∏–∫–æ–Ω–∫–∏ */
      cursor: pointer; 
      color: var(--header-text); 
      padding: 0.5rem;
    }
    #themeToggle { right: 3.5rem; }
    #langToggle { right: 0.5rem; }

    input, select, textarea { 
      background: var(--input-bg); 
      color: var(--input-text); 
      border: 1px solid var(--border-color); 
      border-radius: 0.375rem; /* Bootstrap's default */
      padding: 0.5rem 0.75rem; 
      margin-bottom: 0.75rem; 
      width: 100%; 
      box-sizing: border-box; 
      font-size: 0.95rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--nav-link);
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(var(--nav-link-rgb, 0,123,255), 0.25); /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ü–≤–µ—Ç —Ç–µ–Ω–∏ */
    }
    textarea { resize: vertical; min-height: 80px; }

    .bottom-nav { 
      background: var(--nav-bg); 
      position: fixed; 
      bottom: 0; left: 0; right: 0; 
      display: flex; 
      justify-content: space-around; 
      padding: 0.5rem 0; 
      box-shadow: 0 -2px 5px rgba(0,0,0,0.08); 
      z-index: 1020; 
    }
    .bottom-nav a { 
      color: var(--nav-link); 
      text-decoration: none; 
      font-size: 1.6rem; /* –ò–∫–æ–Ω–∫–∏ –µ—â–µ —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      transition: background-color 0.2s, color 0.2s;
    }
    .bottom-nav a.active {
      background-color: var(--nav-link-active-bg);
      color: var(--nav-link); /* –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–æ–π —Ü–≤–µ—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Å—ã–ª–∫–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    }
     body.dark .bottom-nav a.active {
        color: var(--button-primary-bg); /* –Ø—Ä–∫–∏–π —Ü–≤–µ—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∏–∫–æ–Ω–∫–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    }


    section { display: none; padding: 1.5rem; animation: fadeIn 0.4s ease-out; }
    section.active { display: block; }
    section h5 { font-size: 1.25rem; margin-bottom: 1rem; font-weight: 600; }

    .card-app { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color);
      border-radius: 0.5rem; /* –ú—è–≥—á–µ —É–≥–ª—ã */
      box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
      margin-bottom: 1.25rem; 
      overflow: hidden; 
      cursor: default; /* –£–±–∏—Ä–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –≤—Å–µ–π –∫–∞—Ä—Ç—ã */
      opacity: 0; animation: fadeIn 0.5s forwards; 
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card-app:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }
    .card-body { padding: 1rem; display: flex; align-items: center; justify-content: space-between; }
    .card-body img { width: 48px; height: 48px; border-radius: 0.375rem; object-fit: cover; margin-right: 1rem; }
    .info { flex: 1; cursor: pointer; } /* –ö—É—Ä—Å–æ—Ä –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∫–ª–∏–∫–∞ */
    .info h5 { margin-bottom: 0.3rem; font-size: 1.05rem; font-weight: 600; color: var(--text); }
    .info p { font-size: 0.85rem; margin-bottom: 0.3rem; color: var(--text); opacity: 0.75; }
    .info small { font-size: 0.95rem; color: var(--star-color); }
    .rating-canvas { margin-left: 0.75rem; }
    .favorite-star { 
        cursor: pointer; 
        font-size: 1.8rem; /* –ö—Ä—É–ø–Ω–µ–µ –∑–≤–µ–∑–¥–∞ */
        color: var(--border-color); 
        margin-left: 0.75rem; 
        padding: 0.25rem; 
        transition: color 0.2s, transform 0.2s;
    }
    .favorite-star:hover { transform: scale(1.1); }
    .favorite-star.filled { color: var(--star-color); }

    .category-filters button, .category-filters-main button { 
      margin-right: 0.5rem; margin-bottom: 0.75rem; 
      background-color: var(--input-bg); 
      color: var(--nav-link); 
      border: 1px solid var(--nav-link); 
      padding: 0.4rem 0.9rem; 
      border-radius: 1rem; /* –ë–æ–ª–µ–µ –æ–∫—Ä—É–≥–ª—ã–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
      cursor: pointer; font-size: 0.9rem;
      transition: background-color 0.2s, color 0.2s;
    }
    .category-filters button:hover, .category-filters-main button:hover {
        background-color: var(--nav-link-active-bg);
    }
    .category-filters button.active, .category-filters-main button.active { 
      background-color: var(--nav-link); 
      color: var(--nav-bg); 
      font-weight: 500;
    }
    .view-all-btn { 
      background: none; border: none; 
      color: var(--nav-link); 
      cursor: pointer; font-size: 0.9rem; 
      padding: 0.2rem 0.5rem; font-weight: 500;
    }
    .view-all-btn:hover { text-decoration: underline; }

    .spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--spinner-border); border-radius: 50%; width: 36px; height: 36px; animation: spin 0.8s linear infinite; margin: 2.5rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #searchHistoryList button { 
      background: var(--input-bg); color: var(--text); 
      border: 1px solid var(--border-color); 
      border-radius: 0.75rem; padding: 0.3rem 0.6rem; 
      margin: 0.25rem; cursor: pointer; font-size: 0.85rem;
    }
    #searchHistoryList button:hover { background-color: var(--nav-link-active-bg); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º (–ê–¥–º–∏–Ω–∫–∞ –∏ –ó–∞—è–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) */
    .form-section label { display: block; margin-bottom: 0.3rem; font-weight: 500; font-size: 0.9rem; }
    .form-section button[type="submit"] { 
      background-color: var(--button-primary-bg); 
      color: var(--button-primary-text); 
      border: none; padding: 0.6rem 1.2rem; 
      font-size: 1rem; font-weight: 500;
      cursor: pointer; margin-top: 1rem; border-radius: 0.375rem;
      transition: opacity 0.2s;
    }
    .form-section button[type="submit"]:hover { opacity: 0.85; }
    .form-message { 
        margin-top: 1rem; padding: 0.75rem 1rem; 
        border-radius: 0.375rem; text-align: center; font-size: 0.9rem;
    }
    .form-message.success { background-color: var(--success-color); color: white; }
    .form-message.error { background-color: var(--error-color); color: white; }

    #detailContent img { border-radius: 0.5rem; margin-bottom: 1rem; }
    #detailContent h3 { font-size: 1.75rem; margin-bottom: 0.75rem; font-weight: 600; }
    #detailContent p { margin-bottom: 0.75rem; line-height: 1.7; }
    
    .button-style {
        background-color: var(--button-primary-bg);
        color: var(--button-primary-text);
        border: none;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: opacity 0.2s;
    }
    .button-style:hover {
        opacity: 0.85;
    }
    .button-style.secondary {
        background-color: var(--button-secondary-bg);
        color: var(--button-secondary-text);
    }
    .inactive-btn { background-color: #ccc; color: #666; cursor: not-allowed; opacity: 0.7; }
    #backBtn {
        margin-bottom: 1rem;
        background: var(--input-bg);
        color: var(--nav-link);
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.8rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.9rem;
    }
    #backBtn:hover {
        background-color: var(--nav-link-active-bg);
    }
  </style>
</head>
<body>
  <header>
    <h1 data-i18n="title">TONAggregator</h1>
    <button id="themeToggle" aria-label="Toggle theme">üåô</button>
    <button id="langToggle" aria-label="Toggle language">EN</button>
  </header>

  <section id="search" class="active">
    <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π" readonly data-i18n-placeholder="searchPlaceholder">
    <div class="category-filters-main">
      <button data-i18n="all" class="active">–í—Å–µ</button>
      <button data-i18n="finances">–§–∏–Ω–∞–Ω—Å—ã</button>
      <button data-i18n="games">–ò–≥—Ä—ã</button>
      <button data-i18n="tools">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
    </div>
    <h5><span data-i18n="collections">üî• –ü–æ–¥–±–æ—Ä–∫–∏</span> <button class="view-all-btn" data-target-list-type="collections" data-i18n="viewAll">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button></h5>
    <div id="collections"><div class="spinner"></div></div>
    <h5><span data-i18n="editorChoice">‚úçÔ∏è –í—ã–±–æ—Ä —Ä–µ–¥–∞–∫—Ü–∏–∏</span> <button class="view-all-btn" data-target-list-type="editorChoice" data-i18n="viewAll">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button></h5>
    <div id="editorChoice"><div class="spinner"></div></div>
    <h5><span data-i18n="recentRelease">üÜï –ù–µ–¥–∞–≤–Ω–∏–π —Ä–µ–ª–∏–∑</span> <button class="view-all-btn" data-target-list-type="recentRelease" data-i18n="viewAll">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button></h5>
    <div id="recentRelease"><div class="spinner"></div></div>
    <h5><span data-i18n="allApps">üì± –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span> <button class="view-all-btn" data-target-list-type="all" data-i18n="viewAll">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button></h5>
    <div id="allAppsList"><div class="spinner"></div></div>
  </section>

  <section id="searchOnly">
    <div class="category-filters">
      <button data-i18n="all" class="active">–í—Å–µ</button>
      <button data-i18n="finances">–§–∏–Ω–∞–Ω—Å—ã</button>
      <button data-i18n="games">–ò–≥—Ä—ã</button>
      <button data-i18n="tools">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
    </div>
    <input id="searchOnlyInput" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π" data-i18n-placeholder="searchPlaceholder">
    <div id="searchHistoryList" style="margin-bottom: 0.75rem;"></div>
    <select id="sortSelect">
      <option value="" data-i18n="sortDefault">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</option>
      <option value="rating_desc" data-i18n="sortRatingDesc">–†–µ–π—Ç–∏–Ω–≥ ‚Üì</option>
      <option value="title_asc" data-i18n="sortTitleAsc">–ù–∞–∑–≤–∞–Ω–∏–µ ‚Üë</option>
      <option value="title_desc" data-i18n="sortTitleDesc">–ù–∞–∑–≤–∞–Ω–∏–µ ‚Üì</option>
      <option value="category" data-i18n="sortCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
    </select>
    <div id="searchResults"><div class="spinner"></div></div>
  </section>

  <section id="favorites"><h5 data-i18n="favorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h5><div id="favoritesList"><div class="spinner"></div></div></section>
  
  <section id="profile">
    <h5 data-i18n="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h5>
    <p data-i18n="profileInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.</p>
    <button id="submitAppRequestBtn" class="button-style" data-i18n="submitAppRequestBtnLabel">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
  </section>

  <section id="submitRequest" class="form-section">
    <h5 data-i18n="submitAppTitle">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h5>
    <form id="userSubmitAppForm">
      <div>
        <label for="userAppTitle" data-i18n="userAppTitleLabel">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
        <input type="text" id="userAppTitle" required>
      </div>
      <div>
        <label for="userAppCategory" data-i18n="userAppCategoryLabel">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select id="userAppCategory" required>
          <option value="" data-i18n="selectCategory">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          <option value="–§–∏–Ω–∞–Ω—Å—ã" data-i18n="finances">–§–∏–Ω–∞–Ω—Å—ã</option>
          <option value="–ò–≥—Ä—ã" data-i18n="games">–ò–≥—Ä—ã</option>
          <option value="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" data-i18n="tools">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
          {/* */}
        </select>
      </div>
      <div>
        <label for="userAppDescription" data-i18n="userAppDescriptionLabel">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
        <textarea id="userAppDescription" rows="3" required></textarea>
      </div>
      <div>
        <label for="userAppUrl" data-i18n="userAppUrlLabel">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (URL):</label>
        <input type="url" id="userAppUrl" placeholder="https://example.com/myapp" required>
      </div>
       <div>
        <label for="userAppIconUrl" data-i18n="userAppIconUrlLabel">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫—É (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="url" id="userAppIconUrl" placeholder="https://example.com/icon.png">
      </div>
      <div>
        <label for="userAppContact" data-i18n="userAppContactLabel">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram, Email, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="text" id="userAppContact">
      </div>
      <button type="submit" data-i18n="sendRequestButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
    <div id="userSubmitMessage" class="form-message"></div>
  </section>
  
  <section id="admin" class="form-section">
    <h5 data-i18n="admin">üîß –ê–¥–º–∏–Ω–∫–∞</h5>
    <form id="addAppForm">
      <div>
        <label for="appTitle" data-i18n="appTitleLabel">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
        <input type="text" id="appTitle" required>
      </div>
      <div>
        <label for="appCategory" data-i18n="appCategoryLabel">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select id="appCategory" required>
          <option value="–§–∏–Ω–∞–Ω—Å—ã" data-i18n="finances">–§–∏–Ω–∞–Ω—Å—ã</option>
          <option value="–ò–≥—Ä—ã" data-i18n="games">–ò–≥—Ä—ã</option>
          <option value="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" data-i18n="tools">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
        </select>
      </div>
      <div>
        <label for="appDescription" data-i18n="appDescriptionLabel">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <textarea id="appDescription" rows="3" required></textarea>
      </div>
      <div>
        <label for="appRating" data-i18n="appRatingLabel">–†–µ–π—Ç–∏–Ω–≥ (0-5):</label>
        <input type="number" id="appRating" min="0" max="5" step="0.1" value="4.0" required>
      </div>
      <div>
        <label for="appIcon" data-i18n="appIconLabel">URL –∏–∫–æ–Ω–∫–∏:</label>
        <input type="text" id="appIcon" placeholder="./icon/new_app_icon.jpg" value="./icon/placeholder.png" required>
      </div>
      <button type="submit" data-i18n="addAppButton">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </form>
    <div id="adminMessage" class="form-message"></div>
  </section>

  <section id="detail">
    <button id="backBtn"><span data-i18n="backButton">–ù–∞–∑–∞–¥</span></button>
    <div id="detailContent"><div class="spinner"></div></div>
  </section>

  <nav class="bottom-nav">
    <a href="#search" data-page="search" aria-label="Search Page">üè†</a>
    <a href="#searchOnly" data-page="searchOnly" aria-label="Search Only Page">üîé</a>
    <a href="#favorites" data-page="favorites" aria-label="Favorites Page">‚≠ê</a>
    <a href="#profile" data-page="profile" aria-label="Profile Page">üë§</a>
    <a href="#admin" data-page="admin" aria-label="Admin Page">üîß</a>
  </nav>

  <script type="module">
    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ __firebase_config, –µ—Å–ª–∏ –æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥–ª—É—à–∫—É
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : 
    '{ "apiKey": "AIzaSyBq6O3bhbw8jwiV_qUe8hYj5aO3idYEFc0", "authDomain": "tonaggregator.firebaseapp.com", "projectId": "tonaggregator", "storageBucket": "tonaggregator.firebasestorage.app", "messagingSenderId": "953474860042", "appId": "1:953474860042:web:1fdd159833830fffef8bf3" }';
    // –í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∑–∞–º–µ–Ω–∏—Ç—å YOUR_... –Ω–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Firebase.
    // –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—ã–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –Ω–æ –µ–≥–æ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ Firebase console.
    // const firebaseConfigString = '{ "apiKey": "AIzaSy...", "authDomain": "tonaggregator.firebaseapp.com", ... }'; // –ü—Ä–∏–º–µ—Ä
    
    let firebaseConfig;
    try {
        firebaseConfig = JSON.parse(firebaseConfigString);
    } catch (e) {
        console.error("Invalid Firebase config string:", firebaseConfigString, e);
        document.body.innerHTML = "<p style='color:red; text-align:center; padding: 20px;'>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é __firebase_config –∏–ª–∏ –µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–æ–¥–µ.</p>";
        throw new Error("Invalid Firebase config."); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    }


    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ __app_id, –µ—Å–ª–∏ –æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ton-aggregator-app'; // –ò–∑–º–µ–Ω–∏–ª –Ω–µ–º–Ω–æ–≥–æ default ID

    // –ò–º–ø–æ—Ä—Ç Firebase –º–æ–¥—É–ª–µ–π
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    let fbApp; // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π 'app'
    let db;
    let auth;
    let userId; 

    try {
      fbApp = initializeApp(firebaseConfig);
      db = getFirestore(fbApp);
      auth = getAuth(fbApp);
      console.log("Firebase initialized successfully with project ID:", firebaseConfig.projectId);
    } catch (error) {
      console.error("Firebase initialization error:", error);
      document.body.innerHTML = `<p style='color:red; text-align:center; padding: 20px;'>–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.</p>`;
      // –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:
      db = null; 
      auth = null;
    }
    
    async function authenticateUser() {
      if (!auth) {
        console.error("Firebase Auth is not initialized.");
        return Promise.resolve(null);
      }
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
          console.log("User signed in with custom token.");
        } else {
          await signInAnonymously(auth);
          console.log("User signed in anonymously.");
        }
      } catch (error) {
        console.error("Firebase authentication error:", error);
      }

      return new Promise((resolve) => {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            console.log("User authenticated, UID:", userId);
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª—é—á–∏ localStorage –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è userId
            favorites = new Set(JSON.parse(localStorage.getItem(`favorites_${appId}_${userId}`) || '[]'));
            resolve(user);
          } else {
            userId = 'anonymous'; // –§–æ–ª–ª–±—ç–∫ –¥–ª—è userId, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª
            console.log("User is signed out or auth state not yet determined for anonymous.");
            favorites = new Set(JSON.parse(localStorage.getItem(`favorites_${appId}_anonymous`) || '[]'));
            resolve(null);
          }
        });
      });
    }

    const translations = {
      ru: {
        title: 'TONAggregator', searchPlaceholder: '–ü–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...', viewAll: '–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ',
        collections: 'üî• –ü–æ–¥–±–æ—Ä–∫–∏', editorChoice: '‚úçÔ∏è –í—ã–±–æ—Ä —Ä–µ–¥–∞–∫—Ü–∏–∏', recentRelease: 'üÜï –ù–µ–¥–∞–≤–Ω–∏–π —Ä–µ–ª–∏–∑',
        allApps: 'üì± –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', all: '–í—Å–µ', finances: '–§–∏–Ω–∞–Ω—Å—ã', games: '–ò–≥—Ä—ã', tools: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
        favorites: '‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ', profile: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å', admin: 'üîß –ê–¥–º–∏–Ω–∫–∞',
        profileInfo: '–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º –∏–ª–∏ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–∞—Ç–∞–ª–æ–≥.',
        submitAppRequestBtnLabel: '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
        submitAppTitle: '–ó–∞—è–≤–∫–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è',
        userAppTitleLabel: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', userAppCategoryLabel: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', userAppDescriptionLabel: '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:',
        userAppUrlLabel: '–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (URL):', userAppIconUrlLabel: '–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫—É (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):', userAppContactLabel: '–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram, Email, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):',
        sendRequestButton: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É', requestSentSuccess: '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ!',
        requestSentError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', selectCategory: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...',
        noHistory: '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–∞.', language: 'EN', category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', rating: '–†–µ–π—Ç–∏–Ω–≥',
        appTitleLabel: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ê–¥–º–∏–Ω):', appCategoryLabel: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ê–¥–º–∏–Ω):', appDescriptionLabel: '–û–ø–∏—Å–∞–Ω–∏–µ (–ê–¥–º–∏–Ω):',
        appRatingLabel: '–†–µ–π—Ç–∏–Ω–≥ (0-5) (–ê–¥–º–∏–Ω):', appIconLabel: 'URL –∏–∫–æ–Ω–∫–∏ (–ê–¥–º–∏–Ω):', addAppButton: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ê–¥–º–∏–Ω)',
        appAddedSuccess: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥!', appAddedError: '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.',
        appAddGeneralError: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.',
        backButton: '–ù–∞–∑–∞–¥',
        sortDefault: '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', sortRatingDesc: '–†–µ–π—Ç–∏–Ω–≥ ‚Üì', sortTitleAsc: '–ù–∞–∑–≤–∞–Ω–∏–µ –ê-–Ø ‚Üë', sortTitleDesc: '–ù–∞–∑–≤–∞–Ω–∏–µ –Ø-–ê ‚Üì', sortCategory: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ê-–Ø)',
        loadingApps: '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...', noAppsFound: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.', noFavoritesYet: '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–∞–∂–∞–≤ –Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫—É!',
        appAlreadyExists: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.',
        generalError: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'
      },
      en: {
        title: 'TONAggregator', searchPlaceholder: 'Search apps...', viewAll: 'View All',
        collections: 'üî• Collections', editorChoice: '‚úçÔ∏è Editor\'s Choice', recentRelease: 'üÜï Recent Release',
        allApps: 'üì± All Apps', all: 'All', finances: 'Finance', games: 'Games', tools: 'Tools',
        favorites: '‚≠ê Favorites', profile: 'üë§ Profile', admin: 'üîß Admin',
        profileInfo: 'Here you can manage your profile or submit an application to add a new app to the catalog.',
        submitAppRequestBtnLabel: 'Submit App Request',
        submitAppTitle: 'Application Submission',
        userAppTitleLabel: 'Application Name:', userAppCategoryLabel: 'Category:', userAppDescriptionLabel: 'Short Description:',
        userAppUrlLabel: 'Application URL:', userAppIconUrlLabel: 'Icon URL (optional):', userAppContactLabel: 'Your Contact (Telegram, Email, optional):',
        sendRequestButton: 'Send Request', requestSentSuccess: 'Your application has been successfully submitted for review!',
        requestSentError: 'Error submitting request. Please try again later.', selectCategory: 'Select category...',
        noHistory: 'Search history is empty.', language: 'RU', category: 'Category', rating: 'Rating',
        appTitleLabel: 'App Name (Admin):', appCategoryLabel: 'Category (Admin):', appDescriptionLabel: 'Description (Admin):',
        appRatingLabel: 'Rating (0-5) (Admin):', appIconLabel: 'Icon URL (Admin):', addAppButton: 'Add Application (Admin)',
        appAddedSuccess: 'Application added to catalog successfully!', appAddedError: 'Error: could not add application. Please fill all fields.',
        appAddGeneralError: 'An error occurred while adding the application.',
        backButton: 'Back',
        sortDefault: 'Default Sort', sortRatingDesc: 'Rating ‚Üì', sortTitleAsc: 'Name A-Z ‚Üë', sortTitleDesc: 'Name Z-A ‚Üì', sortCategory: 'Category (A-Z)',
        loadingApps: 'Loading apps...', noAppsFound: 'No apps found.', noFavoritesYet: 'Favorites list is empty. Add apps by clicking the star!',
        appAlreadyExists: 'An app with this name already exists in the catalog.',
        generalError: 'An error occurred. Please refresh the page.'
      }
    };

    let apps = [];

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ Flask API (/apps) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é apps.
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ apps –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è.
     */
    const API_BASE = 'http://127.0.0.1:5001'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ Flask API

    async function loadAppsFromBackend() {
      try {
        const response = await fetch(`${API_BASE}/applications`);
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        // data ‚Äî –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–∞ { id: "...", title: "...", category: "...", description: "...", rating: 4.8, iconURL: "...", ... }
        // –ù–∞–º –Ω—É–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –∂–¥—ë—Ç renderList: –º—ã —Ö—Ä–∞–Ω–∏–º iconURL –≤ –ø–æ–ª–µ `icon`
        apps = data.map(item => ({
          id: item.id,
          title: item.title,
          category: item.category,
          description: item.description,
          rating: item.averageRating || item.rating || 0,
          icon: item.iconURL || '' 
          // –µ—Å–ª–∏ –≤ –±—ç–∫–µ –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–∞—á–µ, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ
        }));
      } catch (err) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', err);
        // –í –∫–∞—á–µ—Å—Ç–≤–µ fallback –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å apps = [] –∏–ª–∏ –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
      }
    }

    let favorites = new Set(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    let appsOrder = JSON.parse(localStorage.getItem(`appsOrder_${appId}`) || 'null');

    const pages = ['search','searchOnly','favorites','profile','admin','detail', 'submitRequest'];
    let currentFilter = ''; // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –∏ –≤ –ø–æ–∏—Å–∫–µ
    let currentSearchPageFilter = ''; // –û—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã searchOnly
    let currentLang = localStorage.getItem('lang') || 'ru';
    
    const APPS_COLLECTION_PATH = `/artifacts/${appId}/public/data/applications`;
    const SUBMITTED_APPS_COLLECTION_PATH = `/artifacts/${appId}/public/data/appSubmissions`;

    async function loadAppsFromFirestore() {
      if (!db) {
        console.error("Firestore DB is not initialized for loading apps.");
        renderList('allAppsList', [], translations[currentLang].generalError);
        renderList('collections', [], ""); renderList('editorChoice', [], ""); renderList('recentRelease', [], "");
        return;
      }
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
      ['collections', 'editorChoice', 'recentRelease', 'allAppsList', 'searchResults', 'favoritesList'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = `<div class="spinner"></div>`;
      });
      
      try {
        const q = query(collection(db, APPS_COLLECTION_PATH), orderBy("createdAt", "desc")); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const querySnapshot = await getDocs(q);
        const firestoreApps = [];
        querySnapshot.forEach((doc) => {
          firestoreApps.push({ id: doc.id, ...doc.data() });
        });
        apps = firestoreApps;

        if (appsOrder && Array.isArray(appsOrder) && appsOrder.length > 0) {
            apps.sort((a, b) => {
                const indexA = appsOrder.indexOf(a.id);
                const indexB = appsOrder.indexOf(b.id);
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1; 
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        } else if (apps.length > 0) { 
            // appsOrder = apps.map(a => a.id); // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –ø—É—Å—Ç—å –±—É–¥–µ—Ç –ø–æ createdAt
            // localStorage.setItem(`appsOrder_${appId}`, JSON.stringify(appsOrder));
        }
        console.log('Apps loaded from Firestore:', apps.length);
      } catch (error) {
        console.error("Error loading apps from Firestore: ", error);
        apps = getDefaultApps(); 
        if (apps.length === 0) { // –ï—Å–ª–∏ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
            ['collections', 'editorChoice', 'recentRelease', 'allAppsList'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.innerHTML = `<p style="text-align:center;">${translations[currentLang].noAppsFound}</p>`;
            });
        }
      } finally {
        initializePageContent(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
      }
    }
    
    function getDefaultApps() {
        console.warn("Loading default apps as fallback or if Firestore is empty.");
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–∑–∞–≥–ª—É—à–∫–∏", –µ—Å–ª–∏ Firestore –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º
        return []; 
    }

    async function addAppToFirestore(appData) {
      if (!db) {
        console.error("Firestore DB is not initialized for adding app.");
        return { error: translations[currentLang].generalError };
      }
      try {
        const q = query(collection(db, APPS_COLLECTION_PATH), where("title", "==", appData.title));
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            return { error: translations[currentLang].appAlreadyExists };
        }
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –¥–ª—è createdAt
        const dataToSave = { ...appData, createdAt: serverTimestamp() };
        const docRef = await addDoc(collection(db, APPS_COLLECTION_PATH), dataToSave);
        console.log("Admin added app with ID: ", docRef.id);
        // –î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞:
        const newAppEntry = { id: docRef.id, ...appData, createdAt: new Date().toISOString() };
        return newAppEntry;
      } catch (error) {
        console.error("Error adding app to Firestore by admin: ", error);
        return { error: error.message };
      }
    }

    async function submitAppRequestToBackend(requestData) {
      try {
        const response = await fetch('http://127.0.0.1:5001/submit-application', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞');
        return result;
      } catch (error) {
        return { error: error.message };
      }
    }
    
    function translateUI() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang] && translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[currentLang] && translations[currentLang][key]) {
          el.placeholder = translations[currentLang][key];
        }
      });
      const langToggleButton = document.getElementById('langToggle');
      if (langToggleButton) {
        langToggleButton.textContent = currentLang === 'ru' ? translations.ru.language : translations.en.language;
      }
      const sortSelect = document.getElementById('sortSelect');
      if (sortSelect) {
        Array.from(sortSelect.options).forEach(option => {
            const key = option.getAttribute('data-i18n');
            if (key && translations[currentLang] && translations[currentLang][key]) {
                option.textContent = translations[currentLang][key];
            }
        });
      }
      renderSearchHistory(); // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç "–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞"
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
      const detailSection = document.getElementById('detail');
      if (detailSection && detailSection.classList.contains('active')) {
        const detailId = location.hash.split('-')[1];
        if (detailId) renderDetail(detailId);
      }
      // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ "—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ"
        document.querySelectorAll('h5 > span[data-i18n], .view-all-btn[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang]?.[key]) {
                el.textContent = translations[currentLang][key];
            }
        });
    }

    function getSearchHistory() {
      return JSON.parse(localStorage.getItem(`searchHistory_${appId}_${userId}`) || '[]');
    }
    function saveSearchTerm(term) {
      let history = getSearchHistory();
      history = history.filter(t => t.toLowerCase() !== term.toLowerCase()); 
      history.unshift(term);
      if (history.length > 7) history.pop(); // –£–≤–µ–ª–∏—á–∏–ª –Ω–µ–º–Ω–æ–≥–æ –∏—Å—Ç–æ—Ä–∏—é
      localStorage.setItem(`searchHistory_${appId}_${userId}`, JSON.stringify(history));
    }
    function renderSearchHistory() {
      const container = document.getElementById('searchHistoryList');
      if (!container) return;
      container.innerHTML = '';
      const history = getSearchHistory();
      if (history.length === 0) {
        const div = document.createElement('div');
        div.textContent = translations[currentLang].noHistory;
        div.style.fontSize = '0.85em';
        div.style.opacity = '0.6';
        div.style.textAlign = 'center';
        div.style.padding = '0.5rem 0';
        container.appendChild(div);
      } else {
        history.forEach(term => {
          const btn = document.createElement('button');
          btn.textContent = term;
          btn.onclick = () => {
            document.getElementById('searchOnlyInput').value = term;
            applySortAndFilter();
          };
          container.appendChild(btn);
        });
      }
    }

    function reorderApps(fromId, toId) {
        const fromIndex = apps.findIndex(a => a.id == fromId);
        const toIndex = apps.findIndex(a => a.id == toId);
        if (fromIndex === -1 || toIndex === -1 || fromIndex === toIndex) return;

        const [movedApp] = apps.splice(fromIndex, 1);
        apps.splice(toIndex, 0, movedApp);
        
        appsOrder = apps.map(a => a.id); 
        localStorage.setItem(`appsOrder_${appId}`, JSON.stringify(appsOrder));
        
        const activeSectionId = document.querySelector('section.active')?.id;
        if (activeSectionId === 'search') {
             filterMainApps(currentFilter, true); 
        } else if (activeSectionId === 'searchOnly') {
            applySortAndFilter(null, true); 
        }
    }

    function enableDragAndDrop(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      let draggedItem = null;
      container.querySelectorAll('.card-app').forEach(card => {
        card.draggable = true;
        card.addEventListener('dragstart', e => {
          draggedItem = e.target.closest('.card-app');
          e.dataTransfer.setData('text/plain', card.dataset.id);
          e.target.style.opacity = '0.5'; 
        });
        card.addEventListener('dragend', e => {
            if(draggedItem) draggedItem.style.opacity = '1';
            draggedItem = null;
            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —É –≤—Å–µ—Ö
            container.querySelectorAll('.card-app').forEach(c => c.style.borderTop = '');
        });
        card.addEventListener('dragover', e => {
          e.preventDefault(); 
          e.dataTransfer.dropEffect = 'move';
        });
         card.addEventListener('dragenter', e => {
            const targetCard = e.target.closest('.card-app');
            if (targetCard && targetCard !== draggedItem) {
                 targetCard.style.borderTop = '3px dashed var(--nav-link)';
            }
        });
        card.addEventListener('dragleave', e => {
            const targetCard = e.target.closest('.card-app');
            if (targetCard) {
                targetCard.style.borderTop = '';
            }
        });
        card.addEventListener('drop', e => {
          e.preventDefault();
          const targetCard = e.target.closest('.card-app');
          if (targetCard) targetCard.style.borderTop = '';

          const fromId = e.dataTransfer.getData('text/plain');
          if (targetCard && targetCard.dataset.id !== fromId) {
            const toId = targetCard.dataset.id;
            reorderApps(fromId, toId);
          }
        });
      });
    }
    
    document.getElementById('backBtn')?.addEventListener('click', () => {
        const previousPage = sessionStorage.getItem('previousPageHash');
        if (previousPage && pages.includes(previousPage.substring(1))) {
            location.hash = previousPage;
        } else if (window.history.length > 1 && document.referrer.includes(location.hostname)) {
            window.history.back();
        } else {
            location.hash = 'search';
        }
    });

    function drawRatingGraphs(containerId) {
      document.querySelectorAll(`#${containerId} .rating-canvas`).forEach(canvas => {
        const rating = parseFloat(canvas.dataset.rating);
        if (isNaN(rating)) return;
        const ctx = canvas.getContext('2d');
        const devicePixelRatio = window.devicePixelRatio || 1;
        canvas.width = 40 * devicePixelRatio;
        canvas.height = 40 * devicePixelRatio;
        canvas.style.width = "40px";
        canvas.style.height = "40px";
        ctx.scale(devicePixelRatio, devicePixelRatio);

        ctx.clearRect(0, 0, 40, 40);
        const centerX = 20;
        const centerY = 20;
        const radius = 17; // –ß—É—Ç—å –º–µ–Ω—å—à–µ
        const lineWidth = 3;
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#e0e0e0';
        ctx.lineWidth = lineWidth -1;
        ctx.stroke();

        if (rating > 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + 2 * Math.PI * (rating / 5));
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--star-color').trim() || '#ffc107';
            ctx.lineWidth = lineWidth;
            ctx.stroke();
        }
      });
    }

    function renderList(containerId, list, messageIfEmpty = translations[currentLang].noAppsFound) {
      const container = document.getElementById(containerId);
      if (!container) { console.warn(`Container ${containerId} not found for renderList.`); return; }
      container.innerHTML = ''; 
      if (!list || list.length === 0) {
        container.innerHTML = `<p style="text-align:center; padding: 1.5rem; opacity: 0.7;">${messageIfEmpty}</p>`;
        return;
      }

      const fragment = document.createDocumentFragment();
      list.forEach(a => {
        if (!a || typeof a.rating === 'undefined' || !a.id) {
            console.warn("Skipping app with missing data (id or rating):", a);
            return; 
        }
        const stars = Math.max(0, Math.min(5, Math.round(a.rating)));
        const starIcons = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
        const card = document.createElement('div');
        card.className = 'card-app';
        card.dataset.id = a.id;
        card.innerHTML = `
          <div class='card-body'>
            <img src='${a.icon || './icon/placeholder.png'}' alt='${a.title}' onerror="this.onerror=null;this.src='https://placehold.co/48x48/eee/ccc?text=N/A';">
            <div class='info' data-app-id="${a.id}">
              <h5>${a.title || 'Unnamed App'}</h5>
              <p>${a.description ? (a.description.length > 75 ? a.description.substring(0, 75) + '...' : a.description) : 'No description available.'}</p>
              <small>${starIcons} (${typeof a.rating === 'number' ? a.rating.toFixed(1) : 'N/A'})</small>
            </div>
            <canvas class="rating-canvas" width="40" height="40" data-rating="${a.rating}"></canvas>
            <span class="favorite-star ${favorites.has(a.id)?'filled':''}" data-fav-id="${a.id}" aria-label="Toggle favorite">‚òÖ</span>
          </div>
        `;
        card.querySelector('.info').addEventListener('click', () => {
            sessionStorage.setItem('previousPageHash', location.hash || '#search');
            location.hash = `detail-${a.id}`;
        });
        card.querySelector('.favorite-star').addEventListener('click', (event) => {
            event.stopPropagation(); 
            toggleFavorite(a.id);
        });
        fragment.appendChild(card);
      });
      container.appendChild(fragment);
      drawRatingGraphs(containerId);
      if ((containerId === 'allAppsList' || containerId === 'searchResults') && !location.hash.includes('favorites')) {
        enableDragAndDrop(containerId);
      }
    }

    function renderDetail(appId) {
      const detailContent = document.getElementById('detailContent');
      if (!detailContent) return;
      detailContent.innerHTML = '<div class="spinner"></div>';
      showPage('detail');
      
      const appData = apps.find(x => x.id == appId);
      if (appData) {
        detailContent.innerHTML = `
          <div style="display: flex; align-items: flex-start; margin-bottom: 1.5rem;">
              <img src='${appData.icon || './icon/placeholder.png'}' alt='${appData.title}' width='100' height='100' style="margin-right: 1.5rem; border-radius: 0.75rem;" onerror="this.onerror=null;this.src='https://placehold.co/100x100/eee/ccc?text=N/A';">
              <div>
                  <h3>${appData.title}</h3>
                  <p style="margin-bottom: 0.5rem; font-size: 1rem;"><strong>${translations[currentLang].category || 'Category'}:</strong> ${appData.category}</p>
                  <p style="font-size: 1rem;"><strong>${translations[currentLang].rating || 'Rating'}:</strong> ${appData.rating} ‚òÖ</p>
              </div>
          </div>
          <p style="font-size: 1.05rem;">${appData.description}</p>
          `;
      } else {
        detailContent.innerHTML = `<p>${translations[currentLang].noAppsFound || 'App not found.'}</p>`;
      }
    }

    function showPage(pageId) {
      pages.forEach(id => document.getElementById(id)?.classList.remove('active'));
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
        document.querySelectorAll('.bottom-nav a').forEach(navLink => {
            navLink.classList.toggle('active', navLink.dataset.page === pageId);
        });
      } else {
        console.warn(`Page ${pageId} not found, showing search page.`);
        document.getElementById('search')?.classList.add('active');
        document.querySelector('.bottom-nav a[data-page="search"]')?.classList.add('active');
      }
      window.scrollTo(0, 0); 
    }
    
    function filterMainApps(category, keepActiveButton = false) {
        if (!keepActiveButton) {
            document.querySelectorAll('.category-filters-main button').forEach(b => b.classList.remove('active'));
            const targetButton = Array.from(document.querySelectorAll('.category-filters-main button')).find(btn => {
                const i18nKey = btn.getAttribute('data-i18n');
                if (category === '' && i18nKey === 'all') return true;
                return translations[currentLang][i18nKey] === category;
            });
            if (targetButton) targetButton.classList.add('active');
        }
        currentFilter = category; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –≥–ª–∞–≤–Ω–æ–π
        const filtered = category ? apps.filter(a => a.category === category) : [...apps];
        renderList('allAppsList', filtered);
    }

    function changeSearchPageFilter(filterCategory) {
      currentSearchPageFilter = filterCategory; // –§–∏–ª—å—Ç—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã searchOnly
      document.querySelectorAll('#searchOnly .category-filters button').forEach(b => b.classList.remove('active'));
      const targetButton = Array.from(document.querySelectorAll('#searchOnly .category-filters button')).find(btn => {
          const i18nKey = btn.getAttribute('data-i18n');
          if (filterCategory === '' && i18nKey === 'all') return true;
          return translations[currentLang][i18nKey] === filterCategory;
      });
      if (targetButton) targetButton.classList.add('active');
      applySortAndFilter();
    }

      async function toggleFavorite(i) {
    const favId = `${currentUserId}_${i}`;  // currentUserId ‚Äî –≥–¥–µ‚Äê—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–∞—à ID (user_1)
    if (favorites.has(i)) {
      // –£–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º DELETE –∑–∞–ø—Ä–æ—Å
      try {
        const response = await fetch(`${API_BASE}/favorites/${favId}`, {
          method: 'DELETE'
        });
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        favorites.delete(i);
      } catch (err) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', err);
        return;
      }
    } else {
      // –ï—â—ë –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º POST
      try {
        const response = await fetch(`${API_BASE}/favorites`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: currentUserId,
            appId: i
          })
        });
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
        const result = await response.json();
        // result.id == favId
        favorites.add(i);
      } catch (err) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', err);
        return;
      }
    }

    // –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏
    localStorage.setItem('favorites', JSON.stringify([...favorites]));
    renderList('favoritesList', apps.filter(a => favorites.has(a.id)));
    applySortAndFilter();
  }


    async function applySortAndFilter(event) {
      const termInput = document.getElementById('searchOnlyInput');
      const term = termInput.value.trim();

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ª–æ–∫–∞–ª—å–Ω–æ –≤ localStorage —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é saveSearchTerm, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ Enter
      if (event && event.type === 'keydown' && event.key === 'Enter' && term) {
        saveSearchTerm(term);
      }
      renderSearchHistory();

      let filteredApps = [...apps];
      if (currentFilter) {
        filteredApps = filteredApps.filter(a => a.category === currentFilter);
      }
      const sortValue = document.getElementById('sortSelect').value;

        if (term) {
          const q = term.toLowerCase();
          filteredApps = filteredApps.filter(a =>
            a.title.toLowerCase().includes(q) ||
            (a.description && a.description.toLowerCase().includes(q))
          );

           switch (sortValue) {
        case 'rating_desc':
          filteredApps.sort((a, b) => (b.rating || 0) - (a.rating || 0));
          break;
        case 'title_asc':
          filteredApps.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'title_desc':
          filteredApps.sort((a, b) => b.title.localeCompare(a.title));
          break;
        case 'category':
          filteredApps.sort((a, b) => a.category.localeCompare(b.category));
          break;
        default:
          break;
      }
    }
  }

   renderList('searchResults', filteredApps);
   
function navigateToSearchWithListType(listType) {
        let listToShow = [];
        switch(listType) {
            case 'collections': listToShow = apps.slice(0,3); break; // –ü—Ä–∏–º–µ—Ä
            case 'editorChoice': listToShow = getEditorChoiceApps(); break;
            case 'recentRelease': listToShow = getRecentReleaseApps(); break;
            case 'all': listToShow = [...apps]; break;
            default: listToShow = [...apps];
        }
        
        sessionStorage.setItem('prefilteredListForSearch', JSON.stringify(listToShow));
        sessionStorage.setItem('initialSearchFilterCategory', ''); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        location.hash = 'searchOnly';
    }


    function handleHashChange() {
      const hash = location.hash.slice(1) || 'search'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 'search'
      sessionStorage.setItem('previousPageHash', location.hash);

      if (hash.startsWith('detail-')) {
        const appIdFromHash = hash.split('-')[1];
        renderDetail(appIdFromHash);
      } else {
        showPage(hash);
        if (hash === 'searchOnly') {
            const prefilteredListJSON = sessionStorage.getItem('prefilteredListForSearch');
            const initialCategory = sessionStorage.getItem('initialSearchFilterCategory') || '';
            
            changeSearchPageFilter(initialCategory); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

            if (prefilteredListJSON) {
                const prefilteredList = JSON.parse(prefilteredListJSON);
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∫ —ç—Ç–æ–º—É —Å–ø–∏—Å–∫—É
                const sortValue = document.getElementById('sortSelect').value;
                 switch(sortValue) { /* ... –ª–æ–≥–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ... */ }
                renderList('searchResults', prefilteredList);
                sessionStorage.removeItem('prefilteredListForSearch');
                sessionStorage.removeItem('initialSearchFilterCategory');
            } else {
                 applySortAndFilter(); 
            }
        } else if (hash === 'search') {
            initializeHomepageLists();
        } else if (hash === 'favorites') {
            renderList('favoritesList', apps.filter(a => favorites.has(a.id)), translations[currentLang].noFavoritesYet);
        } else if (hash === 'submitRequest') {
            document.getElementById('userSubmitAppForm')?.reset();
            document.getElementById('userSubmitMessage').textContent = '';
            document.getElementById('userSubmitMessage').className = 'form-message';
        }
      }
    }
    
    async function handleAdminAddAppFormSubmit(event) {
        event.preventDefault();
        const adminMessage = document.getElementById('adminMessage');
        adminMessage.textContent = ''; 
        adminMessage.className = 'form-message'; 

        const title = document.getElementById('appTitle').value.trim();
        const category = document.getElementById('appCategory').value;
        const description = document.getElementById('appDescription').value.trim();
        const ratingInput = document.getElementById('appRating').value;
        const icon = document.getElementById('appIcon').value.trim() || './icon/placeholder.png'; 

        if (!title || !category || !description || !ratingInput) {
            adminMessage.textContent = translations[currentLang].appAddedError;
            adminMessage.classList.add('error');
            return;
        }
        const rating = parseFloat(ratingInput);
        if (isNaN(rating) || rating < 0 || rating > 5) {
            adminMessage.textContent = '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 5.';
            adminMessage.classList.add('error');
            return;
        }
        const appData = { title, category, description, rating, icon };
        const result = await addAppToFirestore(appData);

        if (result && !result.error && result.id) {
            apps.unshift(result); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
            if (appsOrder) appsOrder.unshift(result.id); else appsOrder = [result.id]; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫
            localStorage.setItem(`appsOrder_${appId}`, JSON.stringify(appsOrder));

            adminMessage.textContent = translations[currentLang].appAddedSuccess;
            adminMessage.classList.add('success');
            document.getElementById('addAppForm').reset(); 
            
            initializeHomepageLists();
            if (document.getElementById('searchOnly').classList.contains('active')) {
                applySortAndFilter();
            }
        } else {
            adminMessage.textContent = result.error || translations[currentLang].appAddGeneralError;
            adminMessage.classList.add('error');
        }
        setTimeout(() => { adminMessage.textContent = ''; adminMessage.className = 'form-message'; }, 7000);
    }

    async function handleUserSubmitAppForm(event) {
        event.preventDefault();
        const userSubmitMessage = document.getElementById('userSubmitMessage');
        userSubmitMessage.textContent = '';
        userSubmitMessage.className = 'form-message';

        const title = document.getElementById('userAppTitle').value.trim();
        const category = document.getElementById('userAppCategory').value;
        const description = document.getElementById('userAppDescription').value.trim();
        const url = document.getElementById('userAppUrl').value.trim();
        const iconUrl = document.getElementById('userAppIconUrl').value.trim();
        const contact = document.getElementById('userAppContact').value.trim();

        if (!title || !category || !description || !url) {
            userSubmitMessage.textContent = translations[currentLang].appAddedError; // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            userSubmitMessage.classList.add('error');
            return;
        }
        const requestData = { title, category, description, url, iconUrl, contact };
        const result = await submitAppRequestToFirestore(requestData);

        if (result && !result.error && result.id) {
            userSubmitMessage.textContent = translations[currentLang].requestSentSuccess;
            userSubmitMessage.classList.add('success');
            document.getElementById('userSubmitAppForm').reset();
        } else {
            userSubmitMessage.textContent = result.error || translations[currentLang].requestSentError;
            userSubmitMessage.classList.add('error');
        }
         setTimeout(() => { userSubmitMessage.textContent = ''; userSubmitMessage.className = 'form-message'; }, 7000);
    }
    
    function getEditorChoiceApps() {
        if (apps.length === 0) return [];
        return [...apps].sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 3); // –¢–æ–ø-3 –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
    }

    function getRecentReleaseApps() {
        if (apps.length === 0) return [];
        return [...apps].filter(a => a.createdAt).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 3); // –¢–æ–ø-3 –ø–æ –¥–∞—Ç–µ
    }
    
    function initializeHomepageLists() {
        if (apps.length === 0 && !document.getElementById('allAppsList').querySelector('.spinner')) {
            // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏ —Å–ø–∏–Ω–Ω–µ—Ä–∞ –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
            // renderList('allAppsList', [], translations[currentLang].noAppsFound); // –£–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ loadApps
            return;
        }
        renderList('collections', apps.slice(0, 3)); 
        renderList('editorChoice', getEditorChoiceApps());
        renderList('recentRelease', getRecentReleaseApps());
        filterMainApps(currentFilter || '', true); // true - —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞
    }
    
    function initializePageContent() {
        translateUI(); // –ü–µ—Ä–µ–≤–æ–¥–∏–º UI
        renderSearchHistory(); // –†–µ–Ω–¥–µ—Ä–∏–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∏—Å–∫–∞
        initializeHomepageLists(); // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        
        const currentHash = location.hash.slice(1) || 'search';
        handleHashChange(); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ö—ç—à –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–∞
        document.querySelectorAll('.bottom-nav a').forEach(navLink => {
            navLink.classList.toggle('active', navLink.dataset.page === currentHash || (currentHash.startsWith('detail-') && navLink.dataset.page === sessionStorage.getItem('previousPageHash')?.substring(1)));
        });
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    document.addEventListener('DOMContentLoaded', async () => {
      document.addEventListener('DOMContentLoaded', async () => {
      // 1) –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Å—Å–∏–≤ apps –∏–∑ –±–µ–∫–µ–Ω–¥–∞
      await loadAppsFromBackend();

      // 2) —Ç–µ–º–∞, —è–∑—ã–∫, –ø–µ—Ä–µ–≤–æ–¥, –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
      translateUI();
      renderSearchHistory();

      // 3) –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è main (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏) –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å filterMainApps, 
      // –Ω–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∂–µ–º –≤—Å–µ:
      filterMainApps('');

      // 4) –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫–∏
      // –ü—É—Å—Ç—å –≤ Firestore —É –≤–∞—Å –µ—Å—Ç—å document collectionsMeta/top3, 
      // –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–µ 3 appRefs. 
      // –ù–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–∫–∞ –≤–æ–∑—å–º—ë–º —Ç—Ä–∏ –ø–µ—Ä–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ apps:
      renderList('collections', apps.slice(0, 3));
      renderList('editorChoice', [apps[0], apps[2]].filter(Boolean));
      renderList('recentRelease', [apps[1], apps[3]].filter(Boolean));

      // 5) –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–µ—Å–ª–∏ –æ–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
      renderList('favoritesList', apps.filter(a => favorites.has(a.id)));

      // 6) —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
      document.getElementById('searchInput').addEventListener('click', () => showPage('searchOnly'));
      document.getElementById('searchOnlyInput').addEventListener('keydown', applySortAndFilter);
      document.getElementById('searchOnlyInput').addEventListener('input', applySortAndFilter);
      document.getElementById('sortSelect').addEventListener('change', applySortAndFilter);
      window.addEventListener('hashchange', handleHashChange);
      handleHashChange();
    });


      await authenticateUser(); 
      await loadAppsFromFirestore(); // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.body.classList.toggle('dark', theme === 'dark');
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        themeToggle.addEventListener('click', () => {
          const isDark = document.body.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
          // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ç–µ–Ω–∏ –¥–ª—è input:focus
          const navLinkColor = getComputedStyle(document.body).getPropertyValue('--nav-link').trim();
          const rgb = navLinkColor.startsWith('#') ? 
            `${parseInt(navLinkColor.slice(1,3),16)},${parseInt(navLinkColor.slice(3,5),16)},${parseInt(navLinkColor.slice(5,7),16)}` : '0,123,255';
          document.documentElement.style.setProperty('--nav-link-rgb', rgb);
          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
          const activeSectionId = document.querySelector('section.active')?.id;
            if (activeSectionId && (activeSectionId === 'search' || activeSectionId === 'searchOnly' || activeSectionId === 'favorites')) {
                drawRatingGraphs(document.getElementById(activeSectionId).querySelector('div[id$="List"], div#searchResults, div#collections, div#editorChoice, div#recentRelease').id);
            } else if (activeSectionId === 'detail') {
                // –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≥—Ä–∞—Ñ–∏–∫ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –µ—Å–ª–∏ –±—É–¥–µ—Ç, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
            }
        });
         // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ --nav-link-rgb –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const initialNavLinkColor = getComputedStyle(document.body).getPropertyValue('--nav-link').trim();
        const initialRgb = initialNavLinkColor.startsWith('#') ? 
            `${parseInt(initialNavLinkColor.slice(1,3),16)},${parseInt(initialNavLinkColor.slice(3,5),16)},${parseInt(initialNavLinkColor.slice(5,7),16)}` : '0,123,255';
        document.documentElement.style.setProperty('--nav-link-rgb', initialRgb);
      }

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è–∑—ã–∫–∞
      const langToggle = document.getElementById('langToggle');
      if (langToggle) {
        langToggle.addEventListener('click', () => {
          currentLang = currentLang === 'ru' ? 'en' : 'ru';
          localStorage.setItem('lang', currentLang);
          translateUI();
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —è–∑—ã–∫–∞
          initializeHomepageLists(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
          if (document.getElementById('searchOnly').classList.contains('active')) applySortAndFilter(null, true); // –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
          if (document.getElementById('favorites').classList.contains('active')) renderList('favoritesList', apps.filter(a => favorites.has(a.id)), translations[currentLang].noFavoritesYet);

        });
      }
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è
      document.querySelectorAll('.bottom-nav a').forEach(link => {
        link.addEventListener('click', (e) => {
            // sessionStorage.setItem('previousPageHash', location.hash || '#search'); // –£–∂–µ –≤ handleHashChange
            // location.hash = link.getAttribute('href'); // –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç handleHashChange
        });
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
      document.querySelectorAll('#search .view-all-btn').forEach(button => {
          button.addEventListener('click', (e) => {
              const listType = e.currentTarget.dataset.targetListType;
              navigateToSearchWithListType(listType);
          });
      });

      // –ü–æ–∏—Å–∫
      document.getElementById('searchInput')?.addEventListener('click', () => {
          sessionStorage.setItem('previousPageHash', '#search');
          location.hash = 'searchOnly';
      });
      document.getElementById('searchOnlyInput')?.addEventListener('keydown', (e) => applySortAndFilter(e));
      document.getElementById('searchOnlyInput')?.addEventListener('input', () => applySortAndFilter(null, true)); // true - –¥–ª—è live search –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª
      document.getElementById('sortSelect')?.addEventListener('change', applySortAndFilter);

      // –§–æ—Ä–º—ã
      document.getElementById('addAppForm')?.addEventListener('submit', handleAdminAddAppFormSubmit);
      document.getElementById('userSubmitAppForm')?.addEventListener('submit', handleUserSubmitAppForm);
      document.getElementById('submitAppRequestBtn')?.addEventListener('click', () => {
          sessionStorage.setItem('previousPageHash', location.hash || '#profile');
          location.hash = 'submitRequest';
      });
      
      // –§–∏–ª—å—Ç—Ä—ã
      document.querySelectorAll('.category-filters-main button').forEach(button => {
        button.addEventListener('click', (e) => {
            const i18nKey = e.currentTarget.getAttribute('data-i18n');
            const category = i18nKey === 'all' ? '' : translations[currentLang][i18nKey];
            filterMainApps(category);
        });
      });
       document.querySelectorAll('#searchOnly .category-filters button').forEach(button => {
        button.addEventListener('click', (e) => {
            const i18nKey = e.currentTarget.getAttribute('data-i18n');
            const category = i18nKey === 'all' ? '' : translations[currentLang][i18nKey];
            changeSearchPageFilter(category);
        });
      });

      window.addEventListener('hashchange', handleHashChange);
      // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ö—ç—à–∞ —É–∂–µ —Å–¥–µ–ª–∞–Ω—ã –≤ loadAppsFromFirestore -> initializePageContent
      // initializePageContent(); // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ loadAppsFromFirestore
    });

  </script>
</body>
</html>
