<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>TONAggregator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* Цветовые переменные */
    :root {
      --bg: #f0f4f8; /* Более светлый фон */
      --text: #333; /* Чуть мягче черный */
      --card-bg: #ffffff;
      --header-bg: #007bff; /* Яркий синий для акцента */
      --header-text: #ffffff;
      --nav-bg: #ffffff;
      --nav-link: #007bff;
      --nav-link-active-bg: #e9ecef;
      --input-bg: #ffffff;
      --input-text: #333;
      --border-color: #dee2e6; /* Стандартный Bootstrap цвет границы */
      --spinner-border: #007bff;
      --success-color: #28a745;
      --error-color: #dc3545;
      --star-color: #ffc107; /* Цвет для звезд рейтинга */
      --button-primary-bg: #007bff;
      --button-primary-text: #ffffff;
      --button-secondary-bg: #6c757d;
      --button-secondary-text: #ffffff;
    }
    body.dark {
      --bg: #121212; /* Глубокий темный */
      --text: #e0e0e0;
      --card-bg: #1e1e1e; /* Темные карточки */
      --header-bg: #1f1f1f; /* Темный хедер */
      --header-text: #e0e0e0;
      --nav-bg: #1a1a1a;
      --nav-link: #bb86fc; /* Фиолетовый акцент для темной темы */
      --nav-link-active-bg: #332244;
      --input-bg: #2c2c2c;
      --input-text: #e0e0e0;
      --border-color: #444444;
      --spinner-border: #bb86fc;
      --star-color: #fdd835;
      --button-primary-bg: #bb86fc;
      --button-primary-text: #121212;
      --button-secondary-bg: #373737;
      --button-secondary-text: #e0e0e0;
    }
    body { 
      background: var(--bg); 
      color: var(--text); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* Более системный шрифт */
      margin: 0; 
      padding-top: 70px; /* Отступ для фиксированного хедера */
      padding-bottom: 80px; /* Отступ для фиксированной навигации */
      transition: background 0.3s, color 0.3s; 
      line-height: 1.6;
    }
    /* Анимация появления */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    header { 
      padding: 0.8rem 1rem; 
      text-align: center; 
      background: var(--header-bg); 
      color: var(--header-text); 
      position: fixed; /* Фиксированный хедер */
      top: 0;
      left: 0;
      right: 0;
      z-index: 1030; /* Выше чем bottom-nav */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 { font-size: 1.5rem; margin: 0; }
    #themeToggle, #langToggle { 
      position: absolute; 
      top: 50%;
      transform: translateY(-50%);
      background: transparent; 
      border: none; 
      font-size: 1.5rem; /* Крупнее иконки */
      cursor: pointer; 
      color: var(--header-text); 
      padding: 0.5rem;
    }
    #themeToggle { right: 3.5rem; }
    #langToggle { right: 0.5rem; }

    input, select, textarea { 
      background: var(--input-bg); 
      color: var(--input-text); 
      border: 1px solid var(--border-color); 
      border-radius: 0.375rem; /* Bootstrap's default */
      padding: 0.5rem 0.75rem; 
      margin-bottom: 0.75rem; 
      width: 100%; 
      box-sizing: border-box; 
      font-size: 0.95rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--nav-link);
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(var(--nav-link-rgb, 0,123,255), 0.25); /* Динамический цвет тени */
    }
    textarea { resize: vertical; min-height: 80px; }

    .bottom-nav { 
      background: var(--nav-bg); 
      position: fixed; 
      bottom: 0; left: 0; right: 0; 
      display: flex; 
      justify-content: space-around; 
      padding: 0.5rem 0; 
      box-shadow: 0 -2px 5px rgba(0,0,0,0.08); 
      z-index: 1020; 
    }
    .bottom-nav a { 
      color: var(--nav-link); 
      text-decoration: none; 
      font-size: 1.6rem; /* Иконки еще чуть крупнее */
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      transition: background-color 0.2s, color 0.2s;
    }
    .bottom-nav a.active {
      background-color: var(--nav-link-active-bg);
      color: var(--nav-link); /* Может потребоваться другой цвет для активной ссылки в темной теме */
    }
     body.dark .bottom-nav a.active {
        color: var(--button-primary-bg); /* Яркий цвет для активной иконки в темной теме */
    }


    section { display: none; padding: 1.5rem; animation: fadeIn 0.4s ease-out; }
    section.active { display: block; }
    section h5 { font-size: 1.25rem; margin-bottom: 1rem; font-weight: 600; }

    .card-app { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color);
      border-radius: 0.5rem; /* Мягче углы */
      box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
      margin-bottom: 1.25rem; 
      overflow: hidden; 
      cursor: default; /* Убираем курсор по умолчанию с всей карты */
      opacity: 0; animation: fadeIn 0.5s forwards; 
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card-app:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }
    .card-body { padding: 1rem; display: flex; align-items: center; justify-content: space-between; }
    .card-body img { width: 48px; height: 48px; border-radius: 0.375rem; object-fit: cover; margin-right: 1rem; }
    .info { flex: 1; cursor: pointer; } /* Курсор на информационный блок для клика */
    .info h5 { margin-bottom: 0.3rem; font-size: 1.05rem; font-weight: 600; color: var(--text); }
    .info p { font-size: 0.85rem; margin-bottom: 0.3rem; color: var(--text); opacity: 0.75; }
    .info small { font-size: 0.95rem; color: var(--star-color); }
    .rating-canvas { margin-left: 0.75rem; }
    .favorite-star { 
        cursor: pointer; 
        font-size: 1.8rem; /* Крупнее звезда */
        color: var(--border-color); 
        margin-left: 0.75rem; 
        padding: 0.25rem; 
        transition: color 0.2s, transform 0.2s;
    }
    .favorite-star:hover { transform: scale(1.1); }
    .favorite-star.filled { color: var(--star-color); }

    .category-filters button, .category-filters-main button { 
      margin-right: 0.5rem; margin-bottom: 0.75rem; 
      background-color: var(--input-bg); 
      color: var(--nav-link); 
      border: 1px solid var(--nav-link); 
      padding: 0.4rem 0.9rem; 
      border-radius: 1rem; /* Более округлые кнопки фильтров */
      cursor: pointer; font-size: 0.9rem;
      transition: background-color 0.2s, color 0.2s;
    }
    .category-filters button:hover, .category-filters-main button:hover {
        background-color: var(--nav-link-active-bg);
    }
    .category-filters button.active, .category-filters-main button.active { 
      background-color: var(--nav-link); 
      color: var(--nav-bg); 
      font-weight: 500;
    }
    .view-all-btn { 
      background: none; border: none; 
      color: var(--nav-link); 
      cursor: pointer; font-size: 0.9rem; 
      padding: 0.2rem 0.5rem; font-weight: 500;
    }
    .view-all-btn:hover { text-decoration: underline; }

    .spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--spinner-border); border-radius: 50%; width: 36px; height: 36px; animation: spin 0.8s linear infinite; margin: 2.5rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #searchHistoryList button { 
      background: var(--input-bg); color: var(--text); 
      border: 1px solid var(--border-color); 
      border-radius: 0.75rem; padding: 0.3rem 0.6rem; 
      margin: 0.25rem; cursor: pointer; font-size: 0.85rem;
    }
    #searchHistoryList button:hover { background-color: var(--nav-link-active-bg); }

    /* Стили для форм (Админка и Заявка пользователя) */
    .form-section label { display: block; margin-bottom: 0.3rem; font-weight: 500; font-size: 0.9rem; }
    .form-section button[type="submit"] { 
      background-color: var(--button-primary-bg); 
      color: var(--button-primary-text); 
      border: none; padding: 0.6rem 1.2rem; 
      font-size: 1rem; font-weight: 500;
      cursor: pointer; margin-top: 1rem; border-radius: 0.375rem;
      transition: opacity 0.2s;
    }
    .form-section button[type="submit"]:hover { opacity: 0.85; }
    .form-message { 
        margin-top: 1rem; padding: 0.75rem 1rem; 
        border-radius: 0.375rem; text-align: center; font-size: 0.9rem;
    }
    .form-message.success { background-color: var(--success-color); color: white; }
    .form-message.error { background-color: var(--error-color); color: white; }

    #detailContent img { border-radius: 0.5rem; margin-bottom: 1rem; }
    #detailContent h3 { font-size: 1.75rem; margin-bottom: 0.75rem; font-weight: 600; }
    #detailContent p { margin-bottom: 0.75rem; line-height: 1.7; }
    
    .button-style {
        background-color: var(--button-primary-bg);
        color: var(--button-primary-text);
        border: none;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: opacity 0.2s;
    }
    .button-style:hover {
        opacity: 0.85;
    }
    .button-style.secondary {
        background-color: var(--button-secondary-bg);
        color: var(--button-secondary-text);
    }
    .inactive-btn { background-color: #ccc; color: #666; cursor: not-allowed; opacity: 0.7; }
    #backBtn {
        margin-bottom: 1rem;
        background: var(--input-bg);
        color: var(--nav-link);
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.8rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.9rem;
    }
    #backBtn:hover {
        background-color: var(--nav-link-active-bg);
    }
  </style>
</head>
<body>
  <header>
    <h1 data-i18n="title">TONAggregator</h1>
    <button id="themeToggle" aria-label="Toggle theme">🌙</button>
    <button id="langToggle" aria-label="Toggle language">EN</button>
  </header>

  <section id="search" class="active">
    <input id="searchInput" placeholder="Поиск приложений" readonly data-i18n-placeholder="searchPlaceholder">
    <div class="category-filters-main">
      <button data-i18n="all" class="active">Все</button>
      <button data-i18n="finances">Финансы</button>
      <button data-i18n="games">Игры</button>
      <button data-i18n="tools">Инструменты</button>
    </div>
    <h5><span data-i18n="collections">🔥 Подборки</span> <button class="view-all-btn" data-target-list-type="collections" data-i18n="viewAll">Смотреть все</button></h5>
    <div id="collections"><div class="spinner"></div></div>
    <h5><span data-i18n="editorChoice">✍️ Выбор редакции</span> <button class="view-all-btn" data-target-list-type="editorChoice" data-i18n="viewAll">Смотреть все</button></h5>
    <div id="editorChoice"><div class="spinner"></div></div>
    <h5><span data-i18n="recentRelease">🆕 Недавний релиз</span> <button class="view-all-btn" data-target-list-type="recentRelease" data-i18n="viewAll">Смотреть все</button></h5>
    <div id="recentRelease"><div class="spinner"></div></div>
    <h5><span data-i18n="allApps">📱 Все приложения</span> <button class="view-all-btn" data-target-list-type="all" data-i18n="viewAll">Смотреть все</button></h5>
    <div id="allAppsList"><div class="spinner"></div></div>
  </section>

  <section id="searchOnly">
    <div class="category-filters">
      <button data-i18n="all" class="active">Все</button>
      <button data-i18n="finances">Финансы</button>
      <button data-i18n="games">Игры</button>
      <button data-i18n="tools">Инструменты</button>
    </div>
    <input id="searchOnlyInput" placeholder="Поиск приложений" data-i18n-placeholder="searchPlaceholder">
    <div id="searchHistoryList" style="margin-bottom: 0.75rem;"></div>
    <select id="sortSelect">
      <option value="" data-i18n="sortDefault">Сортировать</option>
      <option value="rating_desc" data-i18n="sortRatingDesc">Рейтинг ↓</option>
      <option value="title_asc" data-i18n="sortTitleAsc">Название ↑</option>
      <option value="title_desc" data-i18n="sortTitleDesc">Название ↓</option>
      <option value="category" data-i18n="sortCategory">Категория</option>
    </select>
    <div id="searchResults"><div class="spinner"></div></div>
  </section>

  <section id="favorites"><h5 data-i18n="favorites">⭐ Избранное</h5><div id="favoritesList"><div class="spinner"></div></div></section>
  
  <section id="profile">
    <h5 data-i18n="profile">👤 Профиль</h5>
    <p data-i18n="profileInfo">Информация о пользователе и прогресс онбординга.</p>
    <button id="submitAppRequestBtn" class="button-style" data-i18n="submitAppRequestBtnLabel">Подать заявку на добавление приложения</button>
  </section>

  <section id="submitRequest" class="form-section">
    <h5 data-i18n="submitAppTitle">Подать заявку на добавление приложения</h5>
    <form id="userSubmitAppForm">
      <div>
        <label for="userAppTitle" data-i18n="userAppTitleLabel">Название приложения:</label>
        <input type="text" id="userAppTitle" required>
      </div>
      <div>
        <label for="userAppCategory" data-i18n="userAppCategoryLabel">Категория:</label>
        <select id="userAppCategory" required>
          <option value="" data-i18n="selectCategory">Выберите категорию</option>
          <option value="Финансы" data-i18n="finances">Финансы</option>
          <option value="Игры" data-i18n="games">Игры</option>
          <option value="Инструменты" data-i18n="tools">Инструменты</option>
          {/* */}
        </select>
      </div>
      <div>
        <label for="userAppDescription" data-i18n="userAppDescriptionLabel">Краткое описание:</label>
        <textarea id="userAppDescription" rows="3" required></textarea>
      </div>
      <div>
        <label for="userAppUrl" data-i18n="userAppUrlLabel">Ссылка на приложение (URL):</label>
        <input type="url" id="userAppUrl" placeholder="https://example.com/myapp" required>
      </div>
       <div>
        <label for="userAppIconUrl" data-i18n="userAppIconUrlLabel">Ссылка на иконку (URL, опционально):</label>
        <input type="url" id="userAppIconUrl" placeholder="https://example.com/icon.png">
      </div>
      <div>
        <label for="userAppContact" data-i18n="userAppContactLabel">Ваш контакт (Telegram, Email, опционально):</label>
        <input type="text" id="userAppContact">
      </div>
      <button type="submit" data-i18n="sendRequestButton">Отправить заявку</button>
    </form>
    <div id="userSubmitMessage" class="form-message"></div>
  </section>
  
  <section id="admin" class="form-section">
    <h5 data-i18n="admin">🔧 Админка</h5>
    <form id="addAppForm">
      <div>
        <label for="appTitle" data-i18n="appTitleLabel">Название приложения:</label>
        <input type="text" id="appTitle" required>
      </div>
      <div>
        <label for="appCategory" data-i18n="appCategoryLabel">Категория:</label>
        <select id="appCategory" required>
          <option value="Финансы" data-i18n="finances">Финансы</option>
          <option value="Игры" data-i18n="games">Игры</option>
          <option value="Инструменты" data-i18n="tools">Инструменты</option>
        </select>
      </div>
      <div>
        <label for="appDescription" data-i18n="appDescriptionLabel">Описание:</label>
        <textarea id="appDescription" rows="3" required></textarea>
      </div>
      <div>
        <label for="appRating" data-i18n="appRatingLabel">Рейтинг (0-5):</label>
        <input type="number" id="appRating" min="0" max="5" step="0.1" value="4.0" required>
      </div>
      <div>
        <label for="appIcon" data-i18n="appIconLabel">URL иконки:</label>
        <input type="text" id="appIcon" placeholder="./icon/new_app_icon.jpg" value="./icon/placeholder.png" required>
      </div>
      <button type="submit" data-i18n="addAppButton">Добавить приложение</button>
    </form>
    <div id="adminMessage" class="form-message"></div>
  </section>

  <section id="detail">
    <button id="backBtn"><span data-i18n="backButton">Назад</span></button>
    <div id="detailContent"><div class="spinner"></div></div>
  </section>

  <nav class="bottom-nav">
    <a href="#search" data-page="search" aria-label="Search Page">🏠</a>
    <a href="#searchOnly" data-page="searchOnly" aria-label="Search Only Page">🔎</a>
    <a href="#favorites" data-page="favorites" aria-label="Favorites Page">⭐</a>
    <a href="#profile" data-page="profile" aria-label="Profile Page">👤</a>
    <a href="#admin" data-page="admin" aria-label="Admin Page">🔧</a>
  </nav>

  <script type="module">
    // Используйте __firebase_config, если он определен, иначе используйте заглушку
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : 
    '{ "apiKey": "AIzaSyBq6O3bhbw8jwiV_qUe8hYj5aO3idYEFc0", "authDomain": "tonaggregator.firebaseapp.com", "projectId": "tonaggregator", "storageBucket": "tonaggregator.firebasestorage.app", "messagingSenderId": "953474860042", "appId": "1:953474860042:web:1fdd159833830fffef8bf3" }';
    // ВАЖНО: Пользователь должен заменить YOUR_... на свои реальные данные Firebase.
    // Пример реальных данных был в предыдущей версии, но его нужно получать из Firebase console.
    // const firebaseConfigString = '{ "apiKey": "AIzaSy...", "authDomain": "tonaggregator.firebaseapp.com", ... }'; // Пример
    
    let firebaseConfig;
    try {
        firebaseConfig = JSON.parse(firebaseConfigString);
    } catch (e) {
        console.error("Invalid Firebase config string:", firebaseConfigString, e);
        document.body.innerHTML = "<p style='color:red; text-align:center; padding: 20px;'>Критическая ошибка: Неверный формат конфигурации Firebase. Проверьте переменную __firebase_config или ее значение по умолчанию в коде.</p>";
        throw new Error("Invalid Firebase config."); // Останавливаем выполнение
    }


    // Используйте __app_id, если он определен
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ton-aggregator-app'; // Изменил немного default ID

    // Импорт Firebase модулей
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Инициализация Firebase
    let fbApp; // Переименовал, чтобы не конфликтовать с глобальной 'app'
    let db;
    let auth;
    let userId; 

    try {
      fbApp = initializeApp(firebaseConfig);
      db = getFirestore(fbApp);
      auth = getAuth(fbApp);
      console.log("Firebase initialized successfully with project ID:", firebaseConfig.projectId);
    } catch (error) {
      console.error("Firebase initialization error:", error);
      document.body.innerHTML = `<p style='color:red; text-align:center; padding: 20px;'>Ошибка инициализации Firebase: ${error.message}. Проверьте конфигурацию и правила безопасности. Подробности в консоли.</p>`;
      // Для предотвращения дальнейших ошибок, если Firebase не инициализирован:
      db = null; 
      auth = null;
    }
    
    async function authenticateUser() {
      if (!auth) {
        console.error("Firebase Auth is not initialized.");
        return Promise.resolve(null);
      }
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
          console.log("User signed in with custom token.");
        } else {
          await signInAnonymously(auth);
          console.log("User signed in anonymously.");
        }
      } catch (error) {
        console.error("Firebase authentication error:", error);
      }

      return new Promise((resolve) => {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            console.log("User authenticated, UID:", userId);
            // Обновляем ключи localStorage после получения userId
            favorites = new Set(JSON.parse(localStorage.getItem(`favorites_${appId}_${userId}`) || '[]'));
            resolve(user);
          } else {
            userId = 'anonymous'; // Фоллбэк для userId, если пользователь не вошел
            console.log("User is signed out or auth state not yet determined for anonymous.");
            favorites = new Set(JSON.parse(localStorage.getItem(`favorites_${appId}_anonymous`) || '[]'));
            resolve(null);
          }
        });
      });
    }

    const translations = {
      ru: {
        title: 'TONAggregator', searchPlaceholder: 'Поиск приложений...', viewAll: 'Смотреть все',
        collections: '🔥 Подборки', editorChoice: '✍️ Выбор редакции', recentRelease: '🆕 Недавний релиз',
        allApps: '📱 Все приложения', all: 'Все', finances: 'Финансы', games: 'Игры', tools: 'Инструменты',
        favorites: '⭐ Избранное', profile: '👤 Профиль', admin: '🔧 Админка',
        profileInfo: 'Здесь вы можете управлять своим профилем или подать заявку на добавление нового приложения в каталог.',
        submitAppRequestBtnLabel: 'Подать заявку на приложение',
        submitAppTitle: 'Заявка на добавление приложения',
        userAppTitleLabel: 'Название приложения:', userAppCategoryLabel: 'Категория:', userAppDescriptionLabel: 'Краткое описание:',
        userAppUrlLabel: 'Ссылка на приложение (URL):', userAppIconUrlLabel: 'Ссылка на иконку (URL, опционально):', userAppContactLabel: 'Ваш контакт (Telegram, Email, опционально):',
        sendRequestButton: 'Отправить заявку', requestSentSuccess: 'Ваша заявка успешно отправлена на рассмотрение!',
        requestSentError: 'Ошибка при отправке заявки. Пожалуйста, попробуйте позже.', selectCategory: 'Выберите категорию...',
        noHistory: 'История поиска пуста.', language: 'EN', category: 'Категория', rating: 'Рейтинг',
        appTitleLabel: 'Название приложения (Админ):', appCategoryLabel: 'Категория (Админ):', appDescriptionLabel: 'Описание (Админ):',
        appRatingLabel: 'Рейтинг (0-5) (Админ):', appIconLabel: 'URL иконки (Админ):', addAppButton: 'Добавить приложение (Админ)',
        appAddedSuccess: 'Приложение успешно добавлено в каталог!', appAddedError: 'Ошибка: не удалось добавить приложение. Заполните все поля.',
        appAddGeneralError: 'Произошла ошибка при добавлении приложения.',
        backButton: 'Назад',
        sortDefault: 'Сортировка по умолчанию', sortRatingDesc: 'Рейтинг ↓', sortTitleAsc: 'Название А-Я ↑', sortTitleDesc: 'Название Я-А ↓', sortCategory: 'Категория (А-Я)',
        loadingApps: 'Загрузка приложений...', noAppsFound: 'Приложения не найдены.', noFavoritesYet: 'В избранном пока пусто. Добавьте приложения, нажав на звездочку!',
        appAlreadyExists: 'Приложение с таким названием уже существует в каталоге.',
        generalError: 'Произошла ошибка. Пожалуйста, обновите страницу.'
      },
      en: {
        title: 'TONAggregator', searchPlaceholder: 'Search apps...', viewAll: 'View All',
        collections: '🔥 Collections', editorChoice: '✍️ Editor\'s Choice', recentRelease: '🆕 Recent Release',
        allApps: '📱 All Apps', all: 'All', finances: 'Finance', games: 'Games', tools: 'Tools',
        favorites: '⭐ Favorites', profile: '👤 Profile', admin: '🔧 Admin',
        profileInfo: 'Here you can manage your profile or submit an application to add a new app to the catalog.',
        submitAppRequestBtnLabel: 'Submit App Request',
        submitAppTitle: 'Application Submission',
        userAppTitleLabel: 'Application Name:', userAppCategoryLabel: 'Category:', userAppDescriptionLabel: 'Short Description:',
        userAppUrlLabel: 'Application URL:', userAppIconUrlLabel: 'Icon URL (optional):', userAppContactLabel: 'Your Contact (Telegram, Email, optional):',
        sendRequestButton: 'Send Request', requestSentSuccess: 'Your application has been successfully submitted for review!',
        requestSentError: 'Error submitting request. Please try again later.', selectCategory: 'Select category...',
        noHistory: 'Search history is empty.', language: 'RU', category: 'Category', rating: 'Rating',
        appTitleLabel: 'App Name (Admin):', appCategoryLabel: 'Category (Admin):', appDescriptionLabel: 'Description (Admin):',
        appRatingLabel: 'Rating (0-5) (Admin):', appIconLabel: 'Icon URL (Admin):', addAppButton: 'Add Application (Admin)',
        appAddedSuccess: 'Application added to catalog successfully!', appAddedError: 'Error: could not add application. Please fill all fields.',
        appAddGeneralError: 'An error occurred while adding the application.',
        backButton: 'Back',
        sortDefault: 'Default Sort', sortRatingDesc: 'Rating ↓', sortTitleAsc: 'Name A-Z ↑', sortTitleDesc: 'Name Z-A ↓', sortCategory: 'Category (A-Z)',
        loadingApps: 'Loading apps...', noAppsFound: 'No apps found.', noFavoritesYet: 'Favorites list is empty. Add apps by clicking the star!',
        appAlreadyExists: 'An app with this name already exists in the catalog.',
        generalError: 'An error occurred. Please refresh the page.'
      }
    };

    let apps = [];

    /**
     * Загружает все приложения из Flask API (/apps) и сохраняет их в глобальную переменную apps.
     * Возвращает Promise, который резолвится после того, как apps заполнится.
     */
    const API_BASE = 'http://127.0.0.1:5001'; // Замените на адрес вашего Flask API

    async function loadAppsFromBackend() {
      try {
        const response = await fetch(`${API_BASE}/applications`);
        if (!response.ok) {
          throw new Error(`Ошибка ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        // data — массив объектов вида { id: "...", title: "...", category: "...", description: "...", rating: 4.8, iconURL: "...", ... }
        // Нам нужно привести структуру к той, которую ждёт renderList: мы храним iconURL в поле `icon`
        apps = data.map(item => ({
          id: item.id,
          title: item.title,
          category: item.category,
          description: item.description,
          rating: item.averageRating || item.rating || 0,
          icon: item.iconURL || '' 
          // если в бэке поле называется иначе, корректируйте
        }));
      } catch (err) {
        console.error('Не удалось загрузить приложения:', err);
        // В качестве fallback можно оставить apps = [] или вывести сообщение на страницу
      }
    }

    let favorites = new Set(); // Инициализируется после аутентификации
    let appsOrder = JSON.parse(localStorage.getItem(`appsOrder_${appId}`) || 'null');

    const pages = ['search','searchOnly','favorites','profile','admin','detail', 'submitRequest'];
    let currentFilter = ''; // Для фильтров на главной и в поиске
    let currentSearchPageFilter = ''; // Отдельный фильтр для страницы searchOnly
    let currentLang = localStorage.getItem('lang') || 'ru';
    
    const APPS_COLLECTION_PATH = `/artifacts/${appId}/public/data/applications`;
    const SUBMITTED_APPS_COLLECTION_PATH = `/artifacts/${appId}/public/data/appSubmissions`;

    async function loadAppsFromFirestore() {
      if (!db) {
        console.error("Firestore DB is not initialized for loading apps.");
        renderList('allAppsList', [], translations[currentLang].generalError);
        renderList('collections', [], ""); renderList('editorChoice', [], ""); renderList('recentRelease', [], "");
        return;
      }
      // Показываем спиннеры
      ['collections', 'editorChoice', 'recentRelease', 'allAppsList', 'searchResults', 'favoritesList'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = `<div class="spinner"></div>`;
      });
      
      try {
        const q = query(collection(db, APPS_COLLECTION_PATH), orderBy("createdAt", "desc")); // Сортируем по дате добавления по умолчанию
        const querySnapshot = await getDocs(q);
        const firestoreApps = [];
        querySnapshot.forEach((doc) => {
          firestoreApps.push({ id: doc.id, ...doc.data() });
        });
        apps = firestoreApps;

        if (appsOrder && Array.isArray(appsOrder) && appsOrder.length > 0) {
            apps.sort((a, b) => {
                const indexA = appsOrder.indexOf(a.id);
                const indexB = appsOrder.indexOf(b.id);
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1; 
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        } else if (apps.length > 0) { 
            // appsOrder = apps.map(a => a.id); // Не перезаписываем, если его нет, пусть будет по createdAt
            // localStorage.setItem(`appsOrder_${appId}`, JSON.stringify(appsOrder));
        }
        console.log('Apps loaded from Firestore:', apps.length);
      } catch (error) {
        console.error("Error loading apps from Firestore: ", error);
        apps = getDefaultApps(); 
        if (apps.length === 0) { // Если и дефолтные не загрузились
            ['collections', 'editorChoice', 'recentRelease', 'allAppsList'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.innerHTML = `<p style="text-align:center;">${translations[currentLang].noAppsFound}</p>`;
            });
        }
      } finally {
        initializePageContent(); // Инициализируем контент в любом случае
      }
    }
    
    function getDefaultApps() {
        console.warn("Loading default apps as fallback or if Firestore is empty.");
        // Возвращаем пустой массив, чтобы не показывать "заглушки", если Firestore должен быть источником
        return []; 
    }

    async function addAppToFirestore(appData) {
      if (!db) {
        console.error("Firestore DB is not initialized for adding app.");
        return { error: translations[currentLang].generalError };
      }
      try {
        const q = query(collection(db, APPS_COLLECTION_PATH), where("title", "==", appData.title));
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            return { error: translations[currentLang].appAlreadyExists };
        }
        // Добавляем серверную временную метку для createdAt
        const dataToSave = { ...appData, createdAt: serverTimestamp() };
        const docRef = await addDoc(collection(db, APPS_COLLECTION_PATH), dataToSave);
        console.log("Admin added app with ID: ", docRef.id);
        // Для немедленного отображения без перезагрузки данных с сервера:
        const newAppEntry = { id: docRef.id, ...appData, createdAt: new Date().toISOString() };
        return newAppEntry;
      } catch (error) {
        console.error("Error adding app to Firestore by admin: ", error);
        return { error: error.message };
      }
    }

    async function submitAppRequestToBackend(requestData) {
      try {
        const response = await fetch('http://127.0.0.1:5001/submit-application', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Ошибка');
        return result;
      } catch (error) {
        return { error: error.message };
      }
    }
    
    function translateUI() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang] && translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[currentLang] && translations[currentLang][key]) {
          el.placeholder = translations[currentLang][key];
        }
      });
      const langToggleButton = document.getElementById('langToggle');
      if (langToggleButton) {
        langToggleButton.textContent = currentLang === 'ru' ? translations.ru.language : translations.en.language;
      }
      const sortSelect = document.getElementById('sortSelect');
      if (sortSelect) {
        Array.from(sortSelect.options).forEach(option => {
            const key = option.getAttribute('data-i18n');
            if (key && translations[currentLang] && translations[currentLang][key]) {
                option.textContent = translations[currentLang][key];
            }
        });
      }
      renderSearchHistory(); // Обновить текст "Нет истории поиска"
      // Обновить детальную информацию, если она открыта
      const detailSection = document.getElementById('detail');
      if (detailSection && detailSection.classList.contains('active')) {
        const detailId = location.hash.split('-')[1];
        if (detailId) renderDetail(detailId);
      }
      // Обновить заголовки и кнопки "смотреть все"
        document.querySelectorAll('h5 > span[data-i18n], .view-all-btn[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang]?.[key]) {
                el.textContent = translations[currentLang][key];
            }
        });
    }

    function getSearchHistory() {
      return JSON.parse(localStorage.getItem(`searchHistory_${appId}_${userId}`) || '[]');
    }
    function saveSearchTerm(term) {
      let history = getSearchHistory();
      history = history.filter(t => t.toLowerCase() !== term.toLowerCase()); 
      history.unshift(term);
      if (history.length > 7) history.pop(); // Увеличил немного историю
      localStorage.setItem(`searchHistory_${appId}_${userId}`, JSON.stringify(history));
    }
    function renderSearchHistory() {
      const container = document.getElementById('searchHistoryList');
      if (!container) return;
      container.innerHTML = '';
      const history = getSearchHistory();
      if (history.length === 0) {
        const div = document.createElement('div');
        div.textContent = translations[currentLang].noHistory;
        div.style.fontSize = '0.85em';
        div.style.opacity = '0.6';
        div.style.textAlign = 'center';
        div.style.padding = '0.5rem 0';
        container.appendChild(div);
      } else {
        history.forEach(term => {
          const btn = document.createElement('button');
          btn.textContent = term;
          btn.onclick = () => {
            document.getElementById('searchOnlyInput').value = term;
            applySortAndFilter();
          };
          container.appendChild(btn);
        });
      }
    }

    function reorderApps(fromId, toId) {
        const fromIndex = apps.findIndex(a => a.id == fromId);
        const toIndex = apps.findIndex(a => a.id == toId);
        if (fromIndex === -1 || toIndex === -1 || fromIndex === toIndex) return;

        const [movedApp] = apps.splice(fromIndex, 1);
        apps.splice(toIndex, 0, movedApp);
        
        appsOrder = apps.map(a => a.id); 
        localStorage.setItem(`appsOrder_${appId}`, JSON.stringify(appsOrder));
        
        const activeSectionId = document.querySelector('section.active')?.id;
        if (activeSectionId === 'search') {
             filterMainApps(currentFilter, true); 
        } else if (activeSectionId === 'searchOnly') {
            applySortAndFilter(null, true); 
        }
    }

    function enableDragAndDrop(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      let draggedItem = null;
      container.querySelectorAll('.card-app').forEach(card => {
        card.draggable = true;
        card.addEventListener('dragstart', e => {
          draggedItem = e.target.closest('.card-app');
          e.dataTransfer.setData('text/plain', card.dataset.id);
          e.target.style.opacity = '0.5'; 
        });
        card.addEventListener('dragend', e => {
            if(draggedItem) draggedItem.style.opacity = '1';
            draggedItem = null;
            // Убираем подсветку у всех
            container.querySelectorAll('.card-app').forEach(c => c.style.borderTop = '');
        });
        card.addEventListener('dragover', e => {
          e.preventDefault(); 
          e.dataTransfer.dropEffect = 'move';
        });
         card.addEventListener('dragenter', e => {
            const targetCard = e.target.closest('.card-app');
            if (targetCard && targetCard !== draggedItem) {
                 targetCard.style.borderTop = '3px dashed var(--nav-link)';
            }
        });
        card.addEventListener('dragleave', e => {
            const targetCard = e.target.closest('.card-app');
            if (targetCard) {
                targetCard.style.borderTop = '';
            }
        });
        card.addEventListener('drop', e => {
          e.preventDefault();
          const targetCard = e.target.closest('.card-app');
          if (targetCard) targetCard.style.borderTop = '';

          const fromId = e.dataTransfer.getData('text/plain');
          if (targetCard && targetCard.dataset.id !== fromId) {
            const toId = targetCard.dataset.id;
            reorderApps(fromId, toId);
          }
        });
      });
    }
    
    document.getElementById('backBtn')?.addEventListener('click', () => {
        const previousPage = sessionStorage.getItem('previousPageHash');
        if (previousPage && pages.includes(previousPage.substring(1))) {
            location.hash = previousPage;
        } else if (window.history.length > 1 && document.referrer.includes(location.hostname)) {
            window.history.back();
        } else {
            location.hash = 'search';
        }
    });

    function drawRatingGraphs(containerId) {
      document.querySelectorAll(`#${containerId} .rating-canvas`).forEach(canvas => {
        const rating = parseFloat(canvas.dataset.rating);
        if (isNaN(rating)) return;
        const ctx = canvas.getContext('2d');
        const devicePixelRatio = window.devicePixelRatio || 1;
        canvas.width = 40 * devicePixelRatio;
        canvas.height = 40 * devicePixelRatio;
        canvas.style.width = "40px";
        canvas.style.height = "40px";
        ctx.scale(devicePixelRatio, devicePixelRatio);

        ctx.clearRect(0, 0, 40, 40);
        const centerX = 20;
        const centerY = 20;
        const radius = 17; // Чуть меньше
        const lineWidth = 3;
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#e0e0e0';
        ctx.lineWidth = lineWidth -1;
        ctx.stroke();

        if (rating > 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + 2 * Math.PI * (rating / 5));
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--star-color').trim() || '#ffc107';
            ctx.lineWidth = lineWidth;
            ctx.stroke();
        }
      });
    }

    function renderList(containerId, list, messageIfEmpty = translations[currentLang].noAppsFound) {
      const container = document.getElementById(containerId);
      if (!container) { console.warn(`Container ${containerId} not found for renderList.`); return; }
      container.innerHTML = ''; 
      if (!list || list.length === 0) {
        container.innerHTML = `<p style="text-align:center; padding: 1.5rem; opacity: 0.7;">${messageIfEmpty}</p>`;
        return;
      }

      const fragment = document.createDocumentFragment();
      list.forEach(a => {
        if (!a || typeof a.rating === 'undefined' || !a.id) {
            console.warn("Skipping app with missing data (id or rating):", a);
            return; 
        }
        const stars = Math.max(0, Math.min(5, Math.round(a.rating)));
        const starIcons = '★'.repeat(stars) + '☆'.repeat(5 - stars);
        const card = document.createElement('div');
        card.className = 'card-app';
        card.dataset.id = a.id;
        card.innerHTML = `
          <div class='card-body'>
            <img src='${a.icon || './icon/placeholder.png'}' alt='${a.title}' onerror="this.onerror=null;this.src='https://placehold.co/48x48/eee/ccc?text=N/A';">
            <div class='info' data-app-id="${a.id}">
              <h5>${a.title || 'Unnamed App'}</h5>
              <p>${a.description ? (a.description.length > 75 ? a.description.substring(0, 75) + '...' : a.description) : 'No description available.'}</p>
              <small>${starIcons} (${typeof a.rating === 'number' ? a.rating.toFixed(1) : 'N/A'})</small>
            </div>
            <canvas class="rating-canvas" width="40" height="40" data-rating="${a.rating}"></canvas>
            <span class="favorite-star ${favorites.has(a.id)?'filled':''}" data-fav-id="${a.id}" aria-label="Toggle favorite">★</span>
          </div>
        `;
        card.querySelector('.info').addEventListener('click', () => {
            sessionStorage.setItem('previousPageHash', location.hash || '#search');
            location.hash = `detail-${a.id}`;
        });
        card.querySelector('.favorite-star').addEventListener('click', (event) => {
            event.stopPropagation(); 
            toggleFavorite(a.id);
        });
        fragment.appendChild(card);
      });
      container.appendChild(fragment);
      drawRatingGraphs(containerId);
      if ((containerId === 'allAppsList' || containerId === 'searchResults') && !location.hash.includes('favorites')) {
        enableDragAndDrop(containerId);
      }
    }

    function renderDetail(appId) {
      const detailContent = document.getElementById('detailContent');
      if (!detailContent) return;
      detailContent.innerHTML = '<div class="spinner"></div>';
      showPage('detail');
      
      const appData = apps.find(x => x.id == appId);
      if (appData) {
        detailContent.innerHTML = `
          <div style="display: flex; align-items: flex-start; margin-bottom: 1.5rem;">
              <img src='${appData.icon || './icon/placeholder.png'}' alt='${appData.title}' width='100' height='100' style="margin-right: 1.5rem; border-radius: 0.75rem;" onerror="this.onerror=null;this.src='https://placehold.co/100x100/eee/ccc?text=N/A';">
              <div>
                  <h3>${appData.title}</h3>
                  <p style="margin-bottom: 0.5rem; font-size: 1rem;"><strong>${translations[currentLang].category || 'Category'}:</strong> ${appData.category}</p>
                  <p style="font-size: 1rem;"><strong>${translations[currentLang].rating || 'Rating'}:</strong> ${appData.rating} ★</p>
              </div>
          </div>
          <p style="font-size: 1.05rem;">${appData.description}</p>
          `;
      } else {
        detailContent.innerHTML = `<p>${translations[currentLang].noAppsFound || 'App not found.'}</p>`;
      }
    }

    function showPage(pageId) {
      pages.forEach(id => document.getElementById(id)?.classList.remove('active'));
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
        document.querySelectorAll('.bottom-nav a').forEach(navLink => {
            navLink.classList.toggle('active', navLink.dataset.page === pageId);
        });
      } else {
        console.warn(`Page ${pageId} not found, showing search page.`);
        document.getElementById('search')?.classList.add('active');
        document.querySelector('.bottom-nav a[data-page="search"]')?.classList.add('active');
      }
      window.scrollTo(0, 0); 
    }
    
    function filterMainApps(category, keepActiveButton = false) {
        if (!keepActiveButton) {
            document.querySelectorAll('.category-filters-main button').forEach(b => b.classList.remove('active'));
            const targetButton = Array.from(document.querySelectorAll('.category-filters-main button')).find(btn => {
                const i18nKey = btn.getAttribute('data-i18n');
                if (category === '' && i18nKey === 'all') return true;
                return translations[currentLang][i18nKey] === category;
            });
            if (targetButton) targetButton.classList.add('active');
        }
        currentFilter = category; // Глобальный фильтр для главной
        const filtered = category ? apps.filter(a => a.category === category) : [...apps];
        renderList('allAppsList', filtered);
    }

    function changeSearchPageFilter(filterCategory) {
      currentSearchPageFilter = filterCategory; // Фильтр для страницы searchOnly
      document.querySelectorAll('#searchOnly .category-filters button').forEach(b => b.classList.remove('active'));
      const targetButton = Array.from(document.querySelectorAll('#searchOnly .category-filters button')).find(btn => {
          const i18nKey = btn.getAttribute('data-i18n');
          if (filterCategory === '' && i18nKey === 'all') return true;
          return translations[currentLang][i18nKey] === filterCategory;
      });
      if (targetButton) targetButton.classList.add('active');
      applySortAndFilter();
    }

      async function toggleFavorite(i) {
    const favId = `${currentUserId}_${i}`;  // currentUserId — где‐то хранится ваш ID (user_1)
    if (favorites.has(i)) {
      // Уже в избранном — отправляем DELETE запрос
      try {
        const response = await fetch(`${API_BASE}/favorites/${favId}`, {
          method: 'DELETE'
        });
        if (!response.ok) throw new Error('Ошибка удаления из избранного');
        favorites.delete(i);
      } catch (err) {
        console.error('Не удалось удалить из избранного:', err);
        return;
      }
    } else {
      // Ещё нет — отправляем POST
      try {
        const response = await fetch(`${API_BASE}/favorites`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: currentUserId,
            appId: i
          })
        });
        if (!response.ok) throw new Error('Ошибка добавления в избранное');
        const result = await response.json();
        // result.id == favId
        favorites.add(i);
      } catch (err) {
        console.error('Не удалось добавить в избранное:', err);
        return;
      }
    }

    // После изменения состояния перерисовываем списки
    localStorage.setItem('favorites', JSON.stringify([...favorites]));
    renderList('favoritesList', apps.filter(a => favorites.has(a.id)));
    applySortAndFilter();
  }


    async function applySortAndFilter(event) {
      const termInput = document.getElementById('searchOnlyInput');
      const term = termInput.value.trim();

      // сохраняем историю локально в localStorage через функцию saveSearchTerm, если нажали Enter
      if (event && event.type === 'keydown' && event.key === 'Enter' && term) {
        saveSearchTerm(term);
      }
      renderSearchHistory();

      let filteredApps = [...apps];
      if (currentFilter) {
        filteredApps = filteredApps.filter(a => a.category === currentFilter);
      }
      const sortValue = document.getElementById('sortSelect').value;

        if (term) {
          const q = term.toLowerCase();
          filteredApps = filteredApps.filter(a =>
            a.title.toLowerCase().includes(q) ||
            (a.description && a.description.toLowerCase().includes(q))
          );

           switch (sortValue) {
        case 'rating_desc':
          filteredApps.sort((a, b) => (b.rating || 0) - (a.rating || 0));
          break;
        case 'title_asc':
          filteredApps.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'title_desc':
          filteredApps.sort((a, b) => b.title.localeCompare(a.title));
          break;
        case 'category':
          filteredApps.sort((a, b) => a.category.localeCompare(b.category));
          break;
        default:
          break;
      }
    }
  }

   renderList('searchResults', filteredApps);
   
function navigateToSearchWithListType(listType) {
        let listToShow = [];
        switch(listType) {
            case 'collections': listToShow = apps.slice(0,3); break; // Пример
            case 'editorChoice': listToShow = getEditorChoiceApps(); break;
            case 'recentRelease': listToShow = getRecentReleaseApps(); break;
            case 'all': listToShow = [...apps]; break;
            default: listToShow = [...apps];
        }
        
        sessionStorage.setItem('prefilteredListForSearch', JSON.stringify(listToShow));
        sessionStorage.setItem('initialSearchFilterCategory', ''); // Сбрасываем категорию
        location.hash = 'searchOnly';
    }


    function handleHashChange() {
      const hash = location.hash.slice(1) || 'search'; // По умолчанию 'search'
      sessionStorage.setItem('previousPageHash', location.hash);

      if (hash.startsWith('detail-')) {
        const appIdFromHash = hash.split('-')[1];
        renderDetail(appIdFromHash);
      } else {
        showPage(hash);
        if (hash === 'searchOnly') {
            const prefilteredListJSON = sessionStorage.getItem('prefilteredListForSearch');
            const initialCategory = sessionStorage.getItem('initialSearchFilterCategory') || '';
            
            changeSearchPageFilter(initialCategory); // Устанавливаем фильтр по категории

            if (prefilteredListJSON) {
                const prefilteredList = JSON.parse(prefilteredListJSON);
                // Применяем сортировку к этому списку
                const sortValue = document.getElementById('sortSelect').value;
                 switch(sortValue) { /* ... логика сортировки ... */ }
                renderList('searchResults', prefilteredList);
                sessionStorage.removeItem('prefilteredListForSearch');
                sessionStorage.removeItem('initialSearchFilterCategory');
            } else {
                 applySortAndFilter(); 
            }
        } else if (hash === 'search') {
            initializeHomepageLists();
        } else if (hash === 'favorites') {
            renderList('favoritesList', apps.filter(a => favorites.has(a.id)), translations[currentLang].noFavoritesYet);
        } else if (hash === 'submitRequest') {
            document.getElementById('userSubmitAppForm')?.reset();
            document.getElementById('userSubmitMessage').textContent = '';
            document.getElementById('userSubmitMessage').className = 'form-message';
        }
      }
    }
    
    async function handleAdminAddAppFormSubmit(event) {
        event.preventDefault();
        const adminMessage = document.getElementById('adminMessage');
        adminMessage.textContent = ''; 
        adminMessage.className = 'form-message'; 

        const title = document.getElementById('appTitle').value.trim();
        const category = document.getElementById('appCategory').value;
        const description = document.getElementById('appDescription').value.trim();
        const ratingInput = document.getElementById('appRating').value;
        const icon = document.getElementById('appIcon').value.trim() || './icon/placeholder.png'; 

        if (!title || !category || !description || !ratingInput) {
            adminMessage.textContent = translations[currentLang].appAddedError;
            adminMessage.classList.add('error');
            return;
        }
        const rating = parseFloat(ratingInput);
        if (isNaN(rating) || rating < 0 || rating > 5) {
            adminMessage.textContent = 'Рейтинг должен быть числом от 0 до 5.';
            adminMessage.classList.add('error');
            return;
        }
        const appData = { title, category, description, rating, icon };
        const result = await addAppToFirestore(appData);

        if (result && !result.error && result.id) {
            apps.unshift(result); // Добавляем новое приложение в начало локального массива
            if (appsOrder) appsOrder.unshift(result.id); else appsOrder = [result.id]; // Обновляем порядок
            localStorage.setItem(`appsOrder_${appId}`, JSON.stringify(appsOrder));

            adminMessage.textContent = translations[currentLang].appAddedSuccess;
            adminMessage.classList.add('success');
            document.getElementById('addAppForm').reset(); 
            
            initializeHomepageLists();
            if (document.getElementById('searchOnly').classList.contains('active')) {
                applySortAndFilter();
            }
        } else {
            adminMessage.textContent = result.error || translations[currentLang].appAddGeneralError;
            adminMessage.classList.add('error');
        }
        setTimeout(() => { adminMessage.textContent = ''; adminMessage.className = 'form-message'; }, 7000);
    }

    async function handleUserSubmitAppForm(event) {
        event.preventDefault();
        const userSubmitMessage = document.getElementById('userSubmitMessage');
        userSubmitMessage.textContent = '';
        userSubmitMessage.className = 'form-message';

        const title = document.getElementById('userAppTitle').value.trim();
        const category = document.getElementById('userAppCategory').value;
        const description = document.getElementById('userAppDescription').value.trim();
        const url = document.getElementById('userAppUrl').value.trim();
        const iconUrl = document.getElementById('userAppIconUrl').value.trim();
        const contact = document.getElementById('userAppContact').value.trim();

        if (!title || !category || !description || !url) {
            userSubmitMessage.textContent = translations[currentLang].appAddedError; // Можно сделать более специфичное сообщение
            userSubmitMessage.classList.add('error');
            return;
        }
        const requestData = { title, category, description, url, iconUrl, contact };
        const result = await submitAppRequestToFirestore(requestData);

        if (result && !result.error && result.id) {
            userSubmitMessage.textContent = translations[currentLang].requestSentSuccess;
            userSubmitMessage.classList.add('success');
            document.getElementById('userSubmitAppForm').reset();
        } else {
            userSubmitMessage.textContent = result.error || translations[currentLang].requestSentError;
            userSubmitMessage.classList.add('error');
        }
         setTimeout(() => { userSubmitMessage.textContent = ''; userSubmitMessage.className = 'form-message'; }, 7000);
    }
    
    function getEditorChoiceApps() {
        if (apps.length === 0) return [];
        return [...apps].sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 3); // Топ-3 по рейтингу
    }

    function getRecentReleaseApps() {
        if (apps.length === 0) return [];
        return [...apps].filter(a => a.createdAt).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 3); // Топ-3 по дате
    }
    
    function initializeHomepageLists() {
        if (apps.length === 0 && !document.getElementById('allAppsList').querySelector('.spinner')) {
            // Если приложения еще не загружены, и спиннера нет, значит была ошибка или данных нет
            // renderList('allAppsList', [], translations[currentLang].noAppsFound); // Уже обрабатывается в loadApps
            return;
        }
        renderList('collections', apps.slice(0, 3)); 
        renderList('editorChoice', getEditorChoiceApps());
        renderList('recentRelease', getRecentReleaseApps());
        filterMainApps(currentFilter || '', true); // true - чтобы не сбрасывать активную кнопку фильтра
    }
    
    function initializePageContent() {
        translateUI(); // Переводим UI
        renderSearchHistory(); // Рендерим историю поиска
        initializeHomepageLists(); // Рендерим списки на главной
        
        const currentHash = location.hash.slice(1) || 'search';
        handleHashChange(); // Обрабатываем текущий хэш для корректного отображения страницы
        
        // Убедимся, что активная кнопка навигации подсвечена
        document.querySelectorAll('.bottom-nav a').forEach(navLink => {
            navLink.classList.toggle('active', navLink.dataset.page === currentHash || (currentHash.startsWith('detail-') && navLink.dataset.page === sessionStorage.getItem('previousPageHash')?.substring(1)));
        });
    }

    // --- Инициализация приложения ---
    document.addEventListener('DOMContentLoaded', async () => {
      document.addEventListener('DOMContentLoaded', async () => {
      // 1) загрузить массив apps из бекенда
      await loadAppsFromBackend();

      // 2) тема, язык, перевод, история поиска
      translateUI();
      renderSearchHistory();

      // 3) отрисовать главный список на главной странице
      // фильтрация main (категории) будет вызывать filterMainApps, 
      // но изначально покажем все:
      filterMainApps('');

      // 4) отрисовать подборки
      // Пусть в Firestore у вас есть document collectionsMeta/top3, 
      // из которого нужно достать первые 3 appRefs. 
      // Но для упрощения пока возьмём три первых элемента из apps:
      renderList('collections', apps.slice(0, 3));
      renderList('editorChoice', [apps[0], apps[2]].filter(Boolean));
      renderList('recentRelease', [apps[1], apps[3]].filter(Boolean));

      // 5) отрисовать избранное (если оно хранится локально или на бэкенде)
      renderList('favoritesList', apps.filter(a => favorites.has(a.id)));

      // 6) установить слушатели на элементы
      document.getElementById('searchInput').addEventListener('click', () => showPage('searchOnly'));
      document.getElementById('searchOnlyInput').addEventListener('keydown', applySortAndFilter);
      document.getElementById('searchOnlyInput').addEventListener('input', applySortAndFilter);
      document.getElementById('sortSelect').addEventListener('change', applySortAndFilter);
      window.addEventListener('hashchange', handleHashChange);
      handleHashChange();
    });


      await authenticateUser(); 
      await loadAppsFromFirestore(); // Загрузка данных после аутентификации

      // Настройка темы
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.body.classList.toggle('dark', theme === 'dark');
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
        themeToggle.addEventListener('click', () => {
          const isDark = document.body.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          themeToggle.textContent = isDark ? '☀️' : '🌙';
          // Динамическое обновление цвета тени для input:focus
          const navLinkColor = getComputedStyle(document.body).getPropertyValue('--nav-link').trim();
          const rgb = navLinkColor.startsWith('#') ? 
            `${parseInt(navLinkColor.slice(1,3),16)},${parseInt(navLinkColor.slice(3,5),16)},${parseInt(navLinkColor.slice(5,7),16)}` : '0,123,255';
          document.documentElement.style.setProperty('--nav-link-rgb', rgb);
          // Перерисовка графиков
          const activeSectionId = document.querySelector('section.active')?.id;
            if (activeSectionId && (activeSectionId === 'search' || activeSectionId === 'searchOnly' || activeSectionId === 'favorites')) {
                drawRatingGraphs(document.getElementById(activeSectionId).querySelector('div[id$="List"], div#searchResults, div#collections, div#editorChoice, div#recentRelease').id);
            } else if (activeSectionId === 'detail') {
                // Для детальной страницы график не используется, но если будет, нужно будет перерисовать
            }
        });
         // Установка --nav-link-rgb при загрузке
        const initialNavLinkColor = getComputedStyle(document.body).getPropertyValue('--nav-link').trim();
        const initialRgb = initialNavLinkColor.startsWith('#') ? 
            `${parseInt(initialNavLinkColor.slice(1,3),16)},${parseInt(initialNavLinkColor.slice(3,5),16)},${parseInt(initialNavLinkColor.slice(5,7),16)}` : '0,123,255';
        document.documentElement.style.setProperty('--nav-link-rgb', initialRgb);
      }

      // Настройка языка
      const langToggle = document.getElementById('langToggle');
      if (langToggle) {
        langToggle.addEventListener('click', () => {
          currentLang = currentLang === 'ru' ? 'en' : 'ru';
          localStorage.setItem('lang', currentLang);
          translateUI();
          // Обновляем контент, который зависит от языка
          initializeHomepageLists(); // Обновить списки на главной
          if (document.getElementById('searchOnly').classList.contains('active')) applySortAndFilter(null, true); // Обновить результаты поиска
          if (document.getElementById('favorites').classList.contains('active')) renderList('favoritesList', apps.filter(a => favorites.has(a.id)), translations[currentLang].noFavoritesYet);

        });
      }
      
      // Навигация
      document.querySelectorAll('.bottom-nav a').forEach(link => {
        link.addEventListener('click', (e) => {
            // sessionStorage.setItem('previousPageHash', location.hash || '#search'); // Уже в handleHashChange
            // location.hash = link.getAttribute('href'); // Это вызовет handleHashChange
        });
      });

      // Обработчики для кнопок "Смотреть все" на главной
      document.querySelectorAll('#search .view-all-btn').forEach(button => {
          button.addEventListener('click', (e) => {
              const listType = e.currentTarget.dataset.targetListType;
              navigateToSearchWithListType(listType);
          });
      });

      // Поиск
      document.getElementById('searchInput')?.addEventListener('click', () => {
          sessionStorage.setItem('previousPageHash', '#search');
          location.hash = 'searchOnly';
      });
      document.getElementById('searchOnlyInput')?.addEventListener('keydown', (e) => applySortAndFilter(e));
      document.getElementById('searchOnlyInput')?.addEventListener('input', () => applySortAndFilter(null, true)); // true - для live search без сохранения в историю на каждый символ
      document.getElementById('sortSelect')?.addEventListener('change', applySortAndFilter);

      // Формы
      document.getElementById('addAppForm')?.addEventListener('submit', handleAdminAddAppFormSubmit);
      document.getElementById('userSubmitAppForm')?.addEventListener('submit', handleUserSubmitAppForm);
      document.getElementById('submitAppRequestBtn')?.addEventListener('click', () => {
          sessionStorage.setItem('previousPageHash', location.hash || '#profile');
          location.hash = 'submitRequest';
      });
      
      // Фильтры
      document.querySelectorAll('.category-filters-main button').forEach(button => {
        button.addEventListener('click', (e) => {
            const i18nKey = e.currentTarget.getAttribute('data-i18n');
            const category = i18nKey === 'all' ? '' : translations[currentLang][i18nKey];
            filterMainApps(category);
        });
      });
       document.querySelectorAll('#searchOnly .category-filters button').forEach(button => {
        button.addEventListener('click', (e) => {
            const i18nKey = e.currentTarget.getAttribute('data-i18n');
            const category = i18nKey === 'all' ? '' : translations[currentLang][i18nKey];
            changeSearchPageFilter(category);
        });
      });

      window.addEventListener('hashchange', handleHashChange);
      // Первичная инициализация контента и обработка хэша уже сделаны в loadAppsFromFirestore -> initializePageContent
      // initializePageContent(); // Вызывается из loadAppsFromFirestore
    });

  </script>
</body>
</html>
